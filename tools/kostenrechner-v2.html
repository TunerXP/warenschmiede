<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kostenrechner V2 – Warenschmiede</title>
    <meta name="description" content="Kostenrechner V2. Blanko Start, Multi-Page Fix.">
    <link rel="canonical" href="https://www.warenschmiede.com/tools/kostenrechner-v2.html">
    <meta name="robots" content="index,follow">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --input-bg-idle: #e2e8f0; /* Deutliches Grau (Slate-200) */
            --input-border-idle: #cbd5e1; /* Slate-300 */
            --input-text: #1e293b;
            --unit-text: #64748b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 Background */
            color: #334155;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* --- THE BOX INPUT SYSTEM --- */
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .control-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-left: 0.25rem;
        }

        /* Standard Input Box */
        .input-box {
            display: flex;
            align-items: center;
            background-color: var(--input-bg-idle);
            border: 1px solid var(--input-border-idle);
            border-radius: 0.5rem;
            padding: 0 0.75rem;
            height: 2.5rem; /* Feste Höhe */
            transition: all 0.2s ease;
            cursor: text;
            flex-wrap: nowrap;
        }

        .input-box:focus-within {
            background-color: #ffffff;
            border-color: var(--ac);
            box-shadow: 0 0 0 2px var(--ac-light);
        }

        /* Textarea Box */
        .textarea-box {
            display: flex;
            background-color: var(--input-bg-idle);
            border: 1px solid var(--input-border-idle);
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            cursor: text;
            height: auto;
            padding: 0.5rem 0.75rem;
            align-items: flex-start;
        }

        .textarea-box:focus-within {
            background-color: #ffffff;
            border-color: var(--ac);
            box-shadow: 0 0 0 2px var(--ac-light);
        }

        .input-control {
            flex: 1;
            width: 100%;
            min-width: 0;
            background: transparent;
            border: none;
            outline: none;
            font-weight: 600;
            color: var(--input-text);
            text-align: right;
            font-size: 0.9rem;
            padding: 0;
            margin: 0;
        }
        
        .input-control::-webkit-inner-spin-button, 
        .input-control::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .input-control { -moz-appearance: textfield; }

        .input-unit {
            margin-left: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--unit-text);
            user-select: none;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .select-control {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-weight: 600;
            color: var(--input-text);
            font-size: 0.9rem;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0 center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 1.5rem;
        }

        .textarea-control {
            width: 100%;
            background: transparent;
            border: none;
            resize: none;
            outline: none;
            font-weight: 600;
            color: var(--input-text);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* A4 Page Styles */
        .a4-page {
            width: 210mm;
            height: 296mm;
            background: white;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            margin: 0 auto 40px auto;
            padding: 20mm;
            position: relative;
            color: #1f2937;
            font-size: 10pt;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* BEZAHLT STEMPEL */
        .paid-stamp {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-12deg);
            color: #dc2626;
            border: 6px solid #dc2626;
            padding: 1rem 3rem;
            font-size: 5rem;
            font-weight: 900;
            text-transform: uppercase;
            opacity: 0.25;
            z-index: 50;
            pointer-events: none;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 0.1em;
            border-radius: 12px;
            mix-blend-mode: multiply;
            mask-image: url("data:image/svg+xml;utf8,<svg width='100%' height='100%' xmlns='http://www.w3.org/2000/svg'><filter id='noise'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/></filter><rect width='100%' height='100%' filter='url(%23noise)' opacity='0.5'/></svg>");
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }

        /* Print Override */
        @media print {
            @page { margin: 0; size: A4 portrait; }
            body { 
                background: white; 
                height: auto; 
                overflow: visible; 
                margin: 0; 
                display: block; /* WICHTIG: Flexbox entfernen für sauberen Seitenumbruch */
            }
            aside, .no-print { display: none !important; }
            main { 
                padding: 0 !important; 
                margin: 0 !important; 
                width: 100% !important; 
                height: auto !important; 
                display: block !important; /* WICHTIG */
                overflow: visible !important;
            }
            .a4-page { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 210mm !important; 
                height: 296mm !important; 
                page-break-after: always; /* Zwingt neue Seite */
                break-after: page;
                overflow: hidden;
            }
            .a4-page:last-child {
                page-break-after: auto;
                break-after: auto;
            }
        }
    </style>

    <script>
        function appData() {
            return {
                docType: 'angebot',
                theme: { color: 'blue', mode: 'dark' },
                
                colors: {
                    blue: { primary: '#2563eb', light: '#dbeafe' },
                    red: { primary: '#dc2626', light: '#fee2e2' },
                    green: { primary: '#16a34a', light: '#dcfce7' },
                    yellow: { primary: '#ca8a04', light: '#fef9c3' }
                },

                settings: { taxEnabled: false, showCO2: true, showPaid: false },

                defaults: {
                    priceKg: 25.00, energyPrice: 0.40, watts: 250, loadFactor: 80,
                    machineHourly: 2.00, hourlyRate: 50.00, marginPercent: 30.0,
                    laborMinutes: 10, failRate: 5, discount: 0, co2Electricity: 0.40, co2Material: 2.5
                },

                project: { name: 'Projektname', number: 'ANG-2025-001', date: new Date().toISOString().split('T')[0] },
                customer: { name: '', address: '', id: '', orderNumber: '' },
                
                // LEERE STAMMDATEN (Public Version)
                vendor: {
                    company: '', 
                    slogan: '', 
                    name: '',
                    street: '', 
                    zip: '', 
                    city: '', 
                    email: '',
                    phone: '', 
                    bank: '', 
                    iban: '',
                    bic: '', 
                    taxId: '' 
                },

                printJobs: [],
                extraItems: [], // Startet leer!
                itemsPerPageFirst: 4, itemsPerPageNext: 10,

                initApp() {
                    this.loadFromStorage();
                    // Watchers für Auto-Save
                    ['vendor', 'settings', 'defaults', 'printJobs', 'extraItems', 'customer', 'project', 'theme'].forEach(key => {
                        this.$watch(key, () => this.saveToStorage());
                    });
                    
                    // Wenn keine Jobs da sind, füge einen leeren hinzu (damit man was sieht)
                    if (this.printJobs.length === 0) {
                        this.addBlankJob();
                    }
                },

                loadFromStorage() {
                    const saved = localStorage.getItem('ws-calc-v5-6'); 
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            Object.assign(this, data);
                        } catch(e) { console.error("Load Error", e); }
                    }
                },

                saveToStorage() {
                    const data = {
                        vendor: this.vendor, settings: this.settings, extraItems: this.extraItems,
                        customer: this.customer, defaults: this.defaults, printJobs: this.printJobs,
                        project: this.project, theme: this.theme
                    };
                    localStorage.setItem('ws-calc-v5-6', JSON.stringify(data));
                },

                getThemeStyles() {
                    const c = this.colors[this.theme.color] || this.colors.blue;
                    const bgPrev = this.theme.mode === 'light' ? '#f1f5f9' : '#0f172a';
                    return `--ac: ${c.primary}; --ac-light: ${c.light}; --bg-preview: ${bgPrev};`;
                },

                // Neue Funktion für komplett leeren Job
                addBlankJob() {
                    this.printJobs.push({
                        id: Date.now(), 
                        name: '', // LEER
                        quantity: 1, 
                        material: 'pla', 
                        weight: 0, // 0
                        time: 0, // 0
                        priceKg: this.defaults.priceKg, 
                        energyPrice: this.defaults.energyPrice,
                        watts: this.defaults.watts, 
                        loadFactor: this.defaults.loadFactor,
                        machineHourly: this.defaults.machineHourly, 
                        hourlyRate: this.defaults.hourlyRate,
                        marginPercent: this.defaults.marginPercent, 
                        laborMinutes: this.defaults.laborMinutes,
                        failRate: this.defaults.failRate, 
                        discount: this.defaults.discount,
                        fixedCost: 0, 
                        co2Material: this.defaults.co2Material,
                        machinePurchase: 0, 
                        machineLife: 0, 
                        expanded: true
                    });
                },

                // Wird vom Button aufgerufen
                addPrintJob() {
                    this.addBlankJob();
                },

                removePrintJob(idx) {
                    if (this.printJobs.length > 1 || confirm("Letzten Job löschen?")) {
                        this.printJobs.splice(idx, 1);
                    }
                },

                calculateMachineHourly(job) {
                    if (job.machinePurchase > 0 && job.machineLife > 0) {
                        job.machineHourly = (job.machinePurchase / job.machineLife).toFixed(2);
                    }
                },

                applyMaterial(job) {
                    const map = {
                        'pla': { price: 20, co2: 2.5 }, 'pla_plus': { price: 25, co2: 2.6 },
                        'pla_silk': { price: 28, co2: 2.7 }, 'petg': { price: 25, co2: 3.5 },
                        'petg_cf': { price: 45, co2: 3.8 }, 'abs': { price: 25, co2: 4.0 },
                        'abs_cf': { price: 50, co2: 4.5 }, 'asa': { price: 35, co2: 4.2 },
                        'asa_cf': { price: 55, co2: 4.7 }, 'tpu': { price: 38, co2: 3.2 },
                        'pa': { price: 65, co2: 6.0 }
                    };
                    if (map[job.material]) {
                        job.priceKg = map[job.material].price;
                        job.co2Material = map[job.material].co2;
                    }
                },

                calculateJobTotal(job) {
                    const matCost = (job.weight / 1000) * job.priceKg;
                    const actualWatts = job.watts * (job.loadFactor / 100);
                    const energyCost = (actualWatts / 1000) * job.time * job.energyPrice;
                    const machineCost = job.time * job.machineHourly;
                    const laborCost = (job.laborMinutes / 60) * job.hourlyRate;
                    const prodCost = matCost + energyCost + machineCost + laborCost;
                    const failCost = prodCost * (job.failRate / 100);
                    const costWithFixed = prodCost + failCost + (parseFloat(job.fixedCost) || 0);
                    const salesPrice = costWithFixed * (1 + (job.marginPercent / 100));
                    return salesPrice * (1 - (job.discount / 100));
                },

                calculateJobCO2(job) {
                    const matCO2 = (job.weight / 1000) * job.co2Material;
                    const kWh = (job.watts * (job.loadFactor / 100) / 1000) * job.time;
                    return matCO2 + (kWh * this.defaults.co2Electricity);
                },

                getAllPositions() {
                    const jobs = this.printJobs.map((job, idx) => {
                        const up = Math.round(this.calculateJobTotal(job) * 100) / 100;
                        const mats = {
                            pla: 'PLA', pla_plus: 'PLA+', pla_silk: 'PLA Silk', petg: 'PETG',
                            petg_cf: 'PETG-CF', abs: 'ABS', abs_cf: 'ABS-CF', asa: 'ASA',
                            asa_cf: 'ASA-CF', tpu: 'TPU', pa: 'Nylon', custom: 'Custom'
                        };
                        return {
                            pos: String(idx + 1).padStart(2, '0'),
                            desc: job.name || 'Keine Bezeichnung',
                            details: [`${mats[job.material] || job.material}`, `${job.weight}g`, `${job.time}h`],
                            qty: job.quantity, price: up, total: up * job.quantity
                        };
                    });
                    const extras = this.extraItems.map((item, idx) => ({
                        pos: String(jobs.length + 1 + idx).padStart(2, '0'),
                        desc: item.desc, details: [], qty: item.qty, price: item.price, total: item.qty * item.price
                    }));
                    return [...jobs, ...extras];
                },

                getPages() {
                    const all = this.getAllPositions();
                    const pages = [];
                    let i = 0, p = 1;
                    
                    // Always ensure at least one page loop runs even if empty
                    do {
                        const lim = p === 1 ? this.itemsPerPageFirst : this.itemsPerPageNext;
                        const chunk = all.slice(i, i + lim);
                        pages.push({ number: p, items: chunk, isFirst: p === 1, isLast: i + chunk.length >= all.length });
                        i += chunk.length;
                        p++;
                    } while (i < all.length);

                    pages.forEach(pg => pg.totalPages = pages.length);
                    return pages;
                },

                getSubtotal() { return this.getAllPositions().reduce((s, i) => s + i.total, 0); },
                getVat() { return this.settings.taxEnabled ? this.getSubtotal() * 0.19 : 0; },
                getTotal() { return this.getSubtotal() + this.getVat(); },
                getTotalCO2() { return (this.printJobs.reduce((s, j) => s + (this.calculateJobCO2(j) * j.quantity), 0) * 1000).toFixed(0); },
                
                // === SMART FILE NAMING & PRINT ===
                printDocument() {
                    const originalTitle = document.title;
                    
                    // Prefix bestimmen
                    let prefix = "DOKUMENT";
                    if(this.docType === 'angebot') prefix = "ANGEBOT";
                    if(this.docType === 'rechnung') prefix = "RECHNUNG";
                    if(this.docType === 'lieferschein') prefix = "LIEFERSCHEIN";

                    // Namen säubern (Keine Sonderzeichen)
                    const cleanNum = this.project.number ? this.project.number.replace(/[^a-z0-9\-_]/gi, '-') : '000';
                    const cleanCust = this.customer.name ? this.customer.name.replace(/[^a-z0-9\-_]/gi, '_') : 'Kunde';

                    // Titel für den Druckdialog setzen
                    document.title = `${prefix}_${cleanNum}_${cleanCust}`;
                    
                    window.print();
                    
                    // Titel zurücksetzen
                    setTimeout(() => document.title = originalTitle, 500);
                },

                // === SMART JSON EXPORT ===
                exportToFile() {
                    const data = {
                        vendor: this.vendor, settings: this.settings, extraItems: this.extraItems,
                        customer: this.customer, defaults: this.defaults, printJobs: this.printJobs,
                        project: this.project, theme: this.theme
                    };
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    
                    // Name generieren
                    let prefix = "Kalkulation";
                    if(this.docType === 'angebot') prefix = "Kalk_ANG";
                    if(this.docType === 'rechnung') prefix = "Kalk_RE";
                    const cleanNum = this.project.number ? this.project.number.replace(/[^a-z0-9\-_]/gi, '-') : '000';
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${prefix}_${cleanNum}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                importFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            Object.assign(this, data);
                            alert("Daten erfolgreich geladen!");
                        } catch(err) { alert("Fehler beim Laden: " + err.message); }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },
                resetData() {
                    if(confirm("Wirklich alles zurücksetzen?")) {
                        localStorage.removeItem('ws-calc-v5-6');
                        location.reload();
                    }
                },
                formatMoney(v) { return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(v); },
                formatDate(d) { return d ? new Date(d).toLocaleDateString('de-DE') : ''; },
                formatText(t) { return t ? t.replace(/\n/g, '<br>') : ''; },
                getDocumentTitle() {
                    if(this.docType === 'angebot') return 'Angebot';
                    if(this.docType === 'rechnung') return 'Rechnung';
                    if(this.docType === 'lieferschein') return 'Lieferschein';
                    return 'Dokument';
                }
            }
        }
    </script>
</head>
<body class="h-screen overflow-hidden flex" x-data="appData()" x-init="initApp()" :style="getThemeStyles()">

    <!-- SIDEBAR: EINGABEN -->
    <aside class="w-[500px] bg-white border-r border-slate-300 flex flex-col h-full z-20 shadow-2xl shrink-0 no-print">
        
        <!-- App Header -->
        <div class="p-4 border-b border-slate-200 bg-slate-50 flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-[var(--ac)] text-white flex items-center justify-center font-bold text-xl shadow-lg">W</div>
                    <div>
                        <h1 class="font-bold text-slate-800 leading-none">Warenschmiede</h1>
                        <span class="text-[10px] text-slate-400 font-mono uppercase tracking-widest">Calc V5.6</span>
                    </div>
                </div>
                <div class="flex gap-2 bg-white border border-slate-200 rounded-lg p-1 shadow-sm">
                    <template x-for="c in ['blue','red','green','yellow']">
                        <button @click="theme.color = c" :class="`w-5 h-5 rounded-full bg-${c==='yellow'?'yellow-500':c+'-600'} transition-transform hover:scale-110 ${theme.color===c ? 'ring-2 ring-offset-1 ring-slate-400':''}`"></button>
                    </template>
                    <div class="w-px bg-slate-200 mx-1"></div>
                    <button @click="theme.mode = theme.mode==='dark'?'light':'dark'" class="text-slate-400 hover:text-[var(--ac)] px-1"><i class="fa-solid fa-circle-half-stroke"></i></button>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button @click="resetData()" class="px-3 py-1.5 text-xs font-bold text-slate-500 bg-white border border-slate-200 rounded hover:bg-red-50 hover:text-red-600 transition-colors">Reset</button>
                <div class="flex-1"></div>
                <button @click="exportToFile()" class="px-3 py-1.5 text-xs font-bold text-[var(--ac)] bg-[var(--ac-light)] rounded hover:opacity-80 transition-colors"><i class="fa-solid fa-download mr-1"></i> Speichern</button>
                <label class="px-3 py-1.5 text-xs font-bold text-slate-600 bg-slate-200 rounded hover:bg-slate-300 cursor-pointer transition-colors"><i class="fa-solid fa-upload mr-1"></i> Laden <input type="file" class="hidden" accept=".json" @change="importFromFile"></label>
            </div>

            <!-- Website Navigation -->
            <div class="flex items-center justify-between text-[11px] text-slate-500 pt-1 border-t border-slate-100">
                <a href="https://www.warenschmiede.com/" class="hover:text-[var(--ac)] flex items-center gap-1 transition-colors font-medium">
                    <i class="fa-solid fa-arrow-left"></i> Zurück zur Homepage
                </a>
                <div class="flex gap-4">
                    <a href="https://www.warenschmiede.com/impressum.html" class="hover:text-[var(--ac)] transition-colors">Impressum</a>
                    <a href="https://www.warenschmiede.com/datenschutz.html" class="hover:text-[var(--ac)] transition-colors">Datenschutz</a>
                </div>
            </div>
        </div>

        <!-- SCROLLABLE CONTENT -->
        <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scroll bg-slate-50">

            <!-- 1. ANBIETER -->
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-4">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="fa-solid fa-store"></i> Anbieter</div>
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <div class="control-group flex-1">
                            <span class="control-label">Firma</span>
                            <div class="input-box"><input type="text" x-model="vendor.company" class="input-control text-left" placeholder="Firmenname"></div>
                        </div>
                        <div class="control-group flex-1">
                            <span class="control-label">Name</span>
                            <div class="input-box"><input type="text" x-model="vendor.name" class="input-control text-left" placeholder="Inhaber"></div>
                        </div>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Slogan</span>
                        <div class="input-box"><input type="text" x-model="vendor.slogan" class="input-control text-left" placeholder="Dein Slogan"></div>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Anschrift</span>
                        <div class="textarea-box"><textarea x-model="vendor.street" rows="1" class="textarea-control" placeholder="Straße"></textarea></div>
                    </div>
                    <div class="flex gap-3">
                        <div class="control-group w-24">
                            <span class="control-label">PLZ</span>
                            <div class="input-box"><input type="text" x-model="vendor.zip" class="input-control text-left"></div>
                        </div>
                        <div class="control-group flex-1">
                            <span class="control-label">Stadt</span>
                            <div class="input-box"><input type="text" x-model="vendor.city" class="input-control text-left"></div>
                        </div>
                    </div>
                    <details class="text-xs text-slate-500 pt-2 border-t border-slate-100">
                        <summary class="cursor-pointer font-bold hover:text-[var(--ac)]">Bank & Kontakt Details</summary>
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <div class="control-group"><span class="control-label">Email</span><div class="input-box"><input x-model="vendor.email" class="input-control text-left"></div></div>
                            <div class="control-group"><span class="control-label">Tel</span><div class="input-box"><input x-model="vendor.phone" class="input-control text-left"></div></div>
                            <div class="control-group col-span-2"><span class="control-label">IBAN</span><div class="input-box"><input x-model="vendor.iban" class="input-control text-left font-mono"></div></div>
                            <div class="control-group"><span class="control-label">BIC</span><div class="input-box"><input x-model="vendor.bic" class="input-control text-left"></div></div>
                            <div class="control-group"><span class="control-label">Steuer-ID</span><div class="input-box"><input x-model="vendor.taxId" class="input-control text-left"></div></div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- 2. KUNDE & PROJEKT -->
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-4">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i class="fa-solid fa-user"></i> Kunde & Projekt</div>
                
                <!-- Toggle Switch (NEW: With Lieferschein) -->
                <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
                    <button @click="docType='angebot'" :class="docType=='angebot'?'bg-white text-[var(--ac)] shadow-sm':'text-slate-400'" class="flex-1 py-1 text-xs font-bold rounded transition-all">Angebot</button>
                    <button @click="docType='rechnung'" :class="docType=='rechnung'?'bg-white text-[var(--ac)] shadow-sm':'text-slate-400'" class="flex-1 py-1 text-xs font-bold rounded transition-all">Rechnung</button>
                    <button @click="docType='lieferschein'" :class="docType=='lieferschein'?'bg-white text-[var(--ac)] shadow-sm':'text-slate-400'" class="flex-1 py-1 text-xs font-bold rounded transition-all">Liefersch.</button>
                </div>

                <div class="space-y-3">
                    <div class="control-group">
                        <span class="control-label">Kunde / Firma</span>
                        <div class="input-box"><input type="text" x-model="customer.name" class="input-control text-left font-bold"></div>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Anschrift</span>
                        <div class="textarea-box"><textarea x-model="customer.address" rows="2" class="textarea-control"></textarea></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 pt-2 border-t border-slate-100">
                        <div class="control-group">
                            <span class="control-label">Projekt</span>
                            <div class="input-box"><input type="text" x-model="project.name" class="input-control text-left"></div>
                        </div>
                        <div class="control-group">
                            <span class="control-label">Nummer</span>
                            <div class="input-box"><input type="text" x-model="project.number" class="input-control text-right"></div>
                        </div>
                        <div class="control-group">
                            <span class="control-label">Datum</span>
                            <div class="input-box"><input type="date" x-model="project.date" class="input-control text-left"></div>
                        </div>
                        <div class="control-group">
                            <span class="control-label">Kunden-Nr.</span>
                            <div class="input-box"><input type="text" x-model="customer.id" class="input-control text-right"></div>
                        </div>
                    </div>
                    
                    <!-- Settings Toggles -->
                    <div class="flex flex-col gap-2 pt-2" x-show="docType !== 'lieferschein'">
                        <label class="flex items-center justify-between cursor-pointer group">
                            <span class="text-xs font-bold text-slate-500">MwSt (19%) berechnen</span>
                            <div class="relative w-10 h-5 bg-slate-200 rounded-full transition-colors group-hover:bg-slate-300" :class="{'!bg-[var(--ac)]': settings.taxEnabled}">
                                <input type="checkbox" x-model="settings.taxEnabled" class="sr-only">
                                <div class="absolute left-1 top-1 w-3 h-3 bg-white rounded-full transition-transform" :class="{'translate-x-5': settings.taxEnabled}"></div>
                            </div>
                        </label>
                        <label class="flex items-center justify-between cursor-pointer group" x-show="docType==='rechnung'">
                            <span class="text-xs font-bold text-slate-500">"Bezahlt" Stempel</span>
                            <div class="relative w-10 h-5 bg-slate-200 rounded-full transition-colors group-hover:bg-slate-300" :class="{'!bg-red-500': settings.showPaid}">
                                <input type="checkbox" x-model="settings.showPaid" class="sr-only">
                                <div class="absolute left-1 top-1 w-3 h-3 bg-white rounded-full transition-transform" :class="{'translate-x-5': settings.showPaid}"></div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- 3. DRUCK AUFTRÄGE -->
            <div>
                <div class="flex justify-between items-end mb-2">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider"><i class="fa-solid fa-cubes"></i> Aufträge</div>
                    <!-- Defaults Popover -->
                    <div x-data="{open:false}" class="relative">
                        <button @click="open=!open" class="text-[10px] font-bold text-[var(--ac)] hover:underline">Defaults ändern</button>
                        <div x-show="open" @click.outside="open=false" class="absolute right-0 bottom-full mb-2 w-64 bg-white border border-slate-200 shadow-xl rounded-xl p-3 z-50">
                            <h4 class="text-xs font-bold mb-2">Globale Werte</h4>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div class="control-group"><span class="control-label">Strom</span><div class="input-box"><input type="number" x-model.number="defaults.energyPrice" class="input-control"><span class="input-unit">€</span></div></div>
                                <div class="control-group"><span class="control-label">Lohn</span><div class="input-box"><input type="number" x-model.number="defaults.hourlyRate" class="input-control"><span class="input-unit">€/h</span></div></div>
                            </div>
                            <div class="control-group"><span class="control-label">Marge</span><div class="input-box"><input type="number" x-model.number="defaults.marginPercent" class="input-control"><span class="input-unit">%</span></div></div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <template x-for="(job, idx) in printJobs" :key="job.id">
                        <div class="bg-white border border-slate-300 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                            <!-- Job Header -->
                            <div class="bg-slate-100 p-3 flex justify-between items-center cursor-pointer border-b border-slate-200" @click="job.expanded=!job.expanded">
                                <div class="flex items-center gap-3">
                                    <div class="bg-[var(--ac)] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold" x-text="idx+1"></div>
                                    <div>
                                        <div class="font-bold text-sm text-slate-700" x-text="job.name || 'Neues Bauteil'"></div>
                                        <div class="text-[10px] text-slate-500 font-mono">
                                            <span x-text="formatMoney(calculateJobTotal(job))"></span> / Stk
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click.stop="removePrintJob(idx)" class="text-slate-400 hover:text-red-500 p-1"><i class="fa-solid fa-trash"></i></button>
                                    <i class="fa-solid fa-chevron-down text-slate-400 transition-transform" :class="{'rotate-180': job.expanded}"></i>
                                </div>
                            </div>

                            <!-- Job Body -->
                            <div x-show="job.expanded" class="p-4 space-y-4 bg-white">
                                <div class="flex gap-3">
                                    <div class="control-group w-20">
                                        <span class="control-label">Menge</span>
                                        <div class="input-box"><input type="number" x-model.number="job.quantity" class="input-control text-center"></div>
                                    </div>
                                    <div class="control-group flex-1">
                                        <span class="control-label">Bauteil Name</span>
                                        <div class="input-box"><input type="text" x-model="job.name" class="input-control text-left"></div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div class="control-group">
                                        <span class="control-label">Material</span>
                                        <div class="input-box">
                                            <select x-model="job.material" @change="applyMaterial(job)" class="select-control">
                                                <option value="pla">PLA Standard</option>
                                                <option value="pla_plus">PLA+</option>
                                                <option value="pla_silk">PLA Silk</option>
                                                <option value="petg">PETG</option>
                                                <option value="petg_cf">PETG-CF</option>
                                                <option value="abs">ABS</option>
                                                <option value="abs_cf">ABS-CF</option>
                                                <option value="asa">ASA</option>
                                                <option value="asa_cf">ASA-CF</option>
                                                <option value="tpu">TPU (Flex)</option>
                                                <option value="pa">Nylon (PA)</option>
                                                <option value="custom">Eigenes</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="control-group">
                                        <span class="control-label">Filament Preis</span>
                                        <div class="input-box"><input type="number" x-model.number="job.priceKg" class="input-control"><span class="input-unit">€/kg</span></div>
                                    </div>
                                    <div class="control-group">
                                        <span class="control-label">Gewicht</span>
                                        <div class="input-box"><input type="number" x-model.number="job.weight" class="input-control"><span class="input-unit">g</span></div>
                                    </div>
                                    <div class="control-group">
                                        <span class="control-label">Druckzeit</span>
                                        <div class="input-box"><input type="number" x-model.number="job.time" step="0.1" class="input-control"><span class="input-unit">h</span></div>
                                    </div>
                                </div>

                                <!-- Advanced Details -->
                                <details class="border border-slate-200 rounded-lg overflow-hidden group">
                                    <summary class="bg-slate-50 p-2 text-xs font-bold text-slate-500 cursor-pointer flex justify-between hover:bg-slate-100">
                                        <span>Kalkulation Details</span>
                                        <i class="fa-solid fa-plus group-open:hidden"></i>
                                        <i class="fa-solid fa-minus hidden group-open:inline"></i>
                                    </summary>
                                    <div class="p-3 space-y-3 bg-white">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div class="control-group"><span class="control-label">Nachbearb.</span><div class="input-box"><input type="number" x-model.number="job.laborMinutes" class="input-control"><span class="input-unit">min</span></div></div>
                                            <div class="control-group"><span class="control-label">Stundenlohn</span><div class="input-box"><input type="number" x-model.number="job.hourlyRate" class="input-control"><span class="input-unit">€/h</span></div></div>
                                            <div class="control-group"><span class="control-label">Strompreis</span><div class="input-box"><input type="number" x-model.number="job.energyPrice" step="0.01" class="input-control"><span class="input-unit">€</span></div></div>
                                            <div class="control-group"><span class="control-label">Verbrauch</span><div class="input-box"><input type="number" x-model.number="job.watts" class="input-control"><span class="input-unit">W</span></div></div>
                                        </div>
                                        
                                        <div class="p-2 bg-slate-50 rounded border border-slate-100">
                                            <div class="flex justify-between items-center mb-2">
                                                <span class="text-[10px] font-bold text-slate-400 uppercase">Maschine</span>
                                                <div class="control-group w-24"><div class="input-box h-8"><input type="number" x-model.number="job.machineHourly" class="input-control"><span class="input-unit">€/h</span></div></div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div class="control-group"><span class="control-label">Kaufpreis</span><div class="input-box h-8 bg-white"><input type="number" x-model.number="job.machinePurchase" @input="calculateMachineHourly(job)" class="input-control"><span class="input-unit">€</span></div></div>
                                                <div class="control-group"><span class="control-label">Lebensdauer</span><div class="input-box h-8 bg-white"><input type="number" x-model.number="job.machineLife" @input="calculateMachineHourly(job)" class="input-control"><span class="input-unit">h</span></div></div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-3 gap-2">
                                            <div class="control-group"><span class="control-label">Last</span><div class="input-box"><input type="number" x-model.number="job.loadFactor" class="input-control"><span class="input-unit">%</span></div></div>
                                            <div class="control-group"><span class="control-label">Ausschuss</span><div class="input-box"><input type="number" x-model.number="job.failRate" class="input-control"><span class="input-unit">%</span></div></div>
                                            <div class="control-group"><span class="control-label">Fixkosten</span><div class="input-box"><input type="number" x-model.number="job.fixedCost" class="input-control"><span class="input-unit">€</span></div></div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-3 pt-2 border-t border-slate-100">
                                            <div class="control-group">
                                                <span class="control-label text-green-600">Gewinn-Marge</span>
                                                <div class="input-box border-green-200 bg-green-50 focus-within:bg-white focus-within:border-green-500"><input type="number" x-model.number="job.marginPercent" class="input-control text-green-700"><span class="input-unit text-green-600">%</span></div>
                                            </div>
                                            <div class="control-group">
                                                <span class="control-label text-red-600">Rabatt</span>
                                                <div class="input-box border-red-200 bg-red-50 focus-within:bg-white focus-within:border-red-500"><input type="number" x-model.number="job.discount" class="input-control text-red-700"><span class="input-unit text-red-600">%</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </template>
                    
                    <button @click="addPrintJob()" class="w-full py-3 border-2 border-dashed border-slate-300 text-slate-400 font-bold rounded-xl hover:border-[var(--ac)] hover:text-[var(--ac)] hover:bg-white transition-all">+ Weiteres Bauteil</button>
                </div>
            </div>

            <!-- 4. MANUELLE POSITIONEN -->
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm p-4">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3"><i class="fa-solid fa-list"></i> Zusatzpositionen</div>
                <div class="space-y-2">
                    <template x-for="(item, idx) in extraItems" :key="idx">
                        <div class="flex gap-2 items-start">
                            <div class="control-group flex-1">
                                <div class="input-box"><input type="text" x-model="item.desc" class="input-control text-left" placeholder="Beschreibung"></div>
                            </div>
                            <div class="control-group w-16">
                                <div class="input-box"><input type="number" x-model.number="item.qty" class="input-control text-center"></div>
                            </div>
                            <div class="control-group w-24">
                                <div class="input-box"><input type="number" x-model.number="item.price" class="input-control"><span class="input-unit">€</span></div>
                            </div>
                            <button @click="extraItems.splice(idx, 1)" class="mt-2 text-slate-300 hover:text-red-500"><i class="fa-solid fa-times-circle"></i></button>
                        </div>
                    </template>
                    <button @click="extraItems.push({desc:'',qty:1,price:0})" class="text-xs font-bold text-[var(--ac)] hover:underline">+ Position</button>
                </div>
            </div>

        </div>

        <!-- Footer Actions -->
        <div class="p-4 border-t border-slate-200 bg-white">
            <button @click="printDocument()" class="w-full py-3 bg-[var(--ac)] text-white font-bold rounded-lg shadow-lg hover:opacity-90 transform active:scale-95 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-print"></i> Dokument erstellen
            </button>
        </div>
    </aside>

    <!-- PREVIEW AREA -->
    <main class="flex-1 bg-[var(--bg-preview)] flex flex-col items-center py-10 overflow-y-auto">
        <template x-for="page in getPages()">
            <div class="a4-page">
                <!-- PAID STAMP (Nur bei Rechnung) -->
                <template x-if="page.isFirst && settings.showPaid && docType === 'rechnung'"><div class="paid-stamp">BEZAHLT</div></template>

                <!-- HEADER -->
                <div class="flex justify-between items-start border-b-2 pb-6 mb-8" style="border-color: var(--ac)">
                    <div>
                        <h1 class="text-3xl font-extrabold uppercase text-slate-900" x-text="vendor.company"></h1>
                        <p class="text-xs text-slate-500 font-medium tracking-wide uppercase mt-1" x-text="vendor.slogan"></p>
                    </div>
                    <div class="text-right text-[8pt] text-slate-500 font-medium leading-relaxed">
                        <p class="font-bold text-slate-900 uppercase" x-text="vendor.name"></p>
                        <p x-text="vendor.street"></p>
                        <p><span x-text="vendor.zip"></span> <span x-text="vendor.city"></span></p>
                        <p class="text-[var(--ac)] font-bold mt-1" x-text="vendor.email"></p>
                    </div>
                </div>

                <!-- INFO BLOCK -->
                <template x-if="page.isFirst">
                    <div class="flex justify-between mb-10">
                        <div class="w-[85mm]">
                            <p class="text-[6pt] text-slate-400 underline mb-2"><span x-text="vendor.company"></span> • <span x-text="vendor.street"></span> • <span x-text="vendor.zip"></span> <span x-text="vendor.city"></span></p>
                            <div class="text-[10pt] leading-snug p-2 rounded">
                                <div class="font-bold text-slate-900" x-text="customer.name"></div>
                                <div x-html="formatText(customer.address)" class="text-slate-600"></div>
                            </div>
                        </div>
                        <div class="text-right">
                            <h2 class="text-2xl font-bold text-slate-900 mb-2" x-text="getDocumentTitle()"></h2>
                            <div class="text-sm grid grid-cols-[auto_auto] gap-x-4 gap-y-1 justify-end text-slate-600">
                                <span>Nr:</span> <span class="font-mono font-bold text-slate-900" x-text="project.number"></span>
                                <span>Datum:</span> <span x-text="formatDate(project.date)"></span>
                                <span x-show="customer.id">Kd-Nr:</span> <span x-show="customer.id" x-text="customer.id"></span>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- PROJECT TITLE -->
                <template x-if="page.isFirst">
                    <div class="mb-6">
                        <h3 class="font-bold text-lg text-slate-900" x-text="project.name"></h3>
                    </div>
                </template>

                <!-- TABLE -->
                <div class="flex-1">
                    <table class="w-full text-sm">
                        <thead class="border-b-2 text-[var(--ac)]" style="border-color: var(--ac)">
                            <tr class="text-xs font-bold uppercase text-left">
                                <th class="py-2 w-10">Pos</th>
                                <th class="py-2">Beschreibung</th>
                                <th class="py-2 text-right w-16">Menge</th>
                                <!-- Preise ausblenden bei Lieferschein -->
                                <template x-if="docType !== 'lieferschein'">
                                    <th class="py-2 text-right w-24">Einzel</th>
                                </template>
                                <template x-if="docType !== 'lieferschein'">
                                    <th class="py-2 text-right w-24">Gesamt</th>
                                </template>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <template x-for="item in page.items" :key="item.pos">
                                <tr>
                                    <td class="py-3 align-top text-slate-400 font-mono text-xs" x-text="item.pos"></td>
                                    <td class="py-3 align-top">
                                        <div class="font-bold text-slate-800" x-text="item.desc"></div>
                                        <div class="text-xs text-slate-500 mt-1 flex gap-2" x-show="item.details.length">
                                            <template x-for="d in item.details"><span class="bg-slate-50 px-1.5 rounded border border-slate-100" x-text="d"></span></template>
                                        </div>
                                    </td>
                                    <td class="py-3 align-top text-right text-slate-600" x-text="item.qty"></td>
                                    
                                    <!-- Preise ausblenden bei Lieferschein -->
                                    <template x-if="docType !== 'lieferschein'">
                                        <td class="py-3 align-top text-right font-mono text-slate-600" x-text="formatMoney(item.price)"></td>
                                    </template>
                                    <template x-if="docType !== 'lieferschein'">
                                        <td class="py-3 align-top text-right font-mono font-bold text-slate-900" x-text="formatMoney(item.total)"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- FOOTER TOTALS (Nur wenn KEIN Lieferschein) -->
                <template x-if="page.isLast && docType !== 'lieferschein'">
                    <div class="mt-8 border-t-2 pt-4 flex justify-end" style="border-color: var(--ac)">
                        <div class="w-64">
                            <div class="flex justify-between text-sm text-slate-600 mb-1"><span>Netto:</span> <span class="font-mono" x-text="formatMoney(getSubtotal())"></span></div>
                            <template x-if="settings.taxEnabled">
                                <div class="flex justify-between text-sm text-slate-600 mb-2"><span>MwSt 19%:</span> <span class="font-mono" x-text="formatMoney(getVat())"></span></div>
                            </template>
                            <div class="flex justify-between text-xl font-bold text-slate-900 border-t border-slate-200 pt-2">
                                <span>Gesamt:</span> <span class="text-[var(--ac)] font-mono" x-text="formatMoney(getTotal())"></span>
                            </div>
                            <!-- CO2 -->
                            <div x-show="settings.showCO2" class="mt-4 text-xs text-green-600 font-bold text-right flex justify-end items-center gap-1">
                                <i class="fa-solid fa-leaf"></i> <span>CO₂ Footprint: <span x-text="getTotalCO2()"></span>g</span>
                            </div>
                            
                            <!-- LEGAL TEXT (Rechtstext) - Jetzt hier wieder eingefügt -->
                            <div class="mt-4 text-[10px] text-slate-500 text-right leading-tight bg-slate-50 p-2 rounded border border-slate-100">
                                <template x-if="!settings.taxEnabled">
                                    <div>Gemäß §19 UStG wird keine Umsatzsteuer berechnet.<br>Rechnungsbetrag ist sofort fällig ohne Abzug.</div>
                                </template>
                                <template x-if="settings.taxEnabled">
                                    <div>Leistungsdatum entspricht Rechnungsdatum.<br>Zahlbar innerhalb von 14 Tagen netto.</div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- PAGE FOOTER -->
                <div class="mt-auto border-t border-slate-200 pt-4 grid grid-cols-3 text-[7pt] text-slate-400 uppercase">
                    <div>
                        <strong class="text-slate-700 block" x-text="vendor.company"></strong>
                        <span x-text="vendor.street"></span>, <span x-text="vendor.city"></span>
                    </div>
                    <div class="text-center">
                        <span class="block text-slate-700 font-bold">Bankverbindung</span>
                        IBAN: <span x-text="vendor.iban"></span><br>BIC: <span x-text="vendor.bic"></span>
                    </div>
                    <div class="text-right">
                        <div x-show="settings.taxEnabled">Ust-ID: <span x-text="vendor.taxId"></span></div>
                        Seite <span x-text="page.number"></span> / <span x-text="page.totalPages"></span>
                    </div>
                </div>
            </div>
        </template>
    </main>

    <script>
        function formatText(t) { return t ? t.replace(/\n/g, '<br>') : ''; }
    </script>
</body>
</html>