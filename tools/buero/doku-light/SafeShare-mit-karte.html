<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeShare Privacy Map</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Exif-JS -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <!-- Leaflet CSS & JS (für die Karte) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #f43f5e; /* Red for Alert */
            box-shadow: 0 0 15px #f43f5e;
            animation: scan 2s linear infinite;
            display: none;
        }

        @keyframes scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .map-container {
            height: 300px;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1;
        }
        /* Leaflet Dark Mode Tweak */
        .leaflet-layer,
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out,
        .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-5xl bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700 flex flex-col lg:flex-row">

        <!-- Left: Upload & Image -->
        <div class="w-full lg:w-5/12 p-6 border-b lg:border-b-0 lg:border-r border-slate-700 bg-slate-900/50">

            <div class="flex items-center gap-3 mb-6">
                <div class="bg-indigo-500/10 p-2 rounded-lg text-indigo-400">
                    <i class="ph ph-map-pin text-2xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-white text-lg">SafeShare Map</h1>
                    <p class="text-slate-400 text-xs">Visualisiere versteckte Orte</p>
                </div>
            </div>

            <div id="drop-zone" class="w-full aspect-square bg-slate-800 rounded-xl border-2 border-dashed border-slate-600 flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 transition-colors relative overflow-hidden group">
                <input type="file" id="file-input" class="absolute inset-0 opacity-0 cursor-pointer z-20" accept="image/jpeg, image/jpg, image/png">

                <div id="placeholder" class="text-center pointer-events-none transition-opacity duration-300">
                    <div class="w-16 h-16 rounded-full bg-indigo-500/20 flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                        <i class="ph ph-crosshair text-3xl text-indigo-400"></i>
                    </div>
                    <p class="text-slate-300 font-medium">Foto hier analysieren</p>
                    <p class="text-slate-500 text-xs mt-1">S23 Ultra Fotos funktionieren am besten</p>
                </div>

                <img id="preview-img" class="absolute inset-0 w-full h-full object-contain z-10 hidden bg-black/80 backdrop-blur-sm">
                <div id="scan-line" class="scan-line z-10"></div>
            </div>

            <div id="file-name" class="text-center text-xs text-slate-500 mt-2 h-4"></div>
        </div>

        <!-- Right: Map & Results -->
        <div class="w-full lg:w-7/12 p-6 flex flex-col bg-slate-800">

            <div class="flex-grow overflow-y-auto pr-2">
                <!-- Map Area (Hidden by default) -->
                <div id="map-wrapper" class="hidden flex-col gap-4 mb-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-red-400 font-bold text-sm uppercase flex items-center gap-2 animate-pulse">
                            <i class="ph ph-warning-circle"></i> Standort Gefunden!
                        </h3>
                        <a id="gmaps-link" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
                            In Google Maps öffnen <i class="ph ph-arrow-square-out"></i>
                        </a>
                    </div>

                    <div id="map" class="map-container border border-slate-600 shadow-inner"></div>

                    <div class="bg-slate-900 p-3 rounded-lg border border-slate-700 grid grid-cols-2 gap-4 text-xs font-mono text-slate-300">
                        <div>
                            <span class="text-slate-500 block">Breitengrad (Lat)</span>
                            <span id="lat-display">--</span>
                        </div>
                        <div>
                            <span class="text-slate-500 block">Längengrad (Lng)</span>
                            <span id="lng-display">--</span>
                        </div>
                    </div>
                </div>

                <!-- Safe State (Default) -->
                <div id="safe-state" class="hidden flex flex-col items-center justify-center text-center p-6 border border-emerald-900/30 bg-emerald-900/10 rounded-xl mb-6">
                    <i class="ph ph-shield-check text-6xl text-emerald-500 mb-4"></i>
                    <h3 class="text-white font-bold text-xl">Keine GPS Daten</h3>
                    <p class="text-slate-400 text-sm mt-2">Dieses Bild enthält keinen Standort.</p>
                </div>

                <!-- NEW: Metadata Details Block -->
                <div id="metadata-section" class="hidden bg-slate-900 rounded-xl p-4 border border-slate-700 mb-4">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 pb-2 border-b border-slate-800 flex items-center gap-2">
                        <i class="ph ph-info"></i> Bild Details
                    </h4>
                    <div class="grid grid-cols-2 gap-y-3 gap-x-4 text-sm">
                        <div class="text-slate-500 text-xs">Kamera / Gerät</div>
                        <div id="meta-model" class="text-slate-200 text-right font-medium truncate">-</div>

                        <div class="text-slate-500 text-xs">Aufnahmedatum</div>
                        <div id="meta-date" class="text-slate-200 text-right font-medium truncate">-</div>

                        <div class="text-slate-500 text-xs">Software</div>
                        <div id="meta-soft" class="text-slate-200 text-right font-medium truncate">-</div>

                        <div class="text-slate-500 text-xs">Einstellungen</div>
                        <div id="meta-settings" class="text-slate-200 text-right font-mono text-xs truncate">-</div>
                    </div>
                </div>

                <!-- Initial State -->
                <div id="initial-state" class="h-full flex flex-col items-center justify-center text-center p-6 opacity-50">
                    <i class="ph ph-map-trifold text-6xl text-slate-600 mb-4"></i>
                    <p class="text-slate-400 text-sm">Lade ein Bild hoch, um zu sehen,<br>wo es aufgenommen wurde.</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4 pt-4 border-t border-slate-700 flex gap-3 shrink-0">
                <button id="clean-btn" disabled onclick="cleanImage()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2">
                    <i class="ph ph-eraser"></i>
                    <span>GPS & Daten löschen</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const previewImg = document.getElementById('preview-img');
        const scanLine = document.getElementById('scan-line');
        const mapWrapper = document.getElementById('map-wrapper');
        const safeState = document.getElementById('safe-state');
        const initialState = document.getElementById('initial-state');
        const metadataSection = document.getElementById('metadata-section');
        const cleanBtn = document.getElementById('clean-btn');
        const fileNameDisplay = document.getElementById('file-name');

        const latDisplay = document.getElementById('lat-display');
        const lngDisplay = document.getElementById('lng-display');
        const gmapsLink = document.getElementById('gmaps-link');

        // Metadata Fields
        const metaModel = document.getElementById('meta-model');
        const metaDate = document.getElementById('meta-date');
        const metaSoft = document.getElementById('meta-soft');
        const metaSettings = document.getElementById('meta-settings');

        let map = null;
        let originalFile = null;

        // --- Logic ---

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            originalFile = file;
            fileNameDisplay.textContent = file.name;

            // UI Reset
            resetUI();

            // Show Preview
            const url = URL.createObjectURL(file);
            previewImg.src = url;
            previewImg.classList.remove('hidden');
            document.getElementById('placeholder').classList.add('opacity-0');

            // Animate Scan
            scanLine.style.display = 'block';

            setTimeout(() => {
                analyzeImage(file);
            }, 800);
        });

        function analyzeImage(file) {
            EXIF.getData(file, function() {
                const lat = EXIF.getTag(this, "GPSLatitude");
                const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                const lng = EXIF.getTag(this, "GPSLongitude");
                const lngRef = EXIF.getTag(this, "GPSLongitudeRef");

                // Hide Initial / Scan
                scanLine.style.display = 'none';
                initialState.classList.add('hidden');

                // 1. Handle Map / Safe State
                if(lat && lng) {
                    const decimalLat = convertDMSToDD(lat, latRef);
                    const decimalLng = convertDMSToDD(lng, lngRef);
                    showMap(decimalLat, decimalLng);
                } else {
                    safeState.classList.remove('hidden');
                }

                // 2. Handle Extra Metadata
                updateMetadataDisplay(this);

                cleanBtn.disabled = false;
            });
        }

        function updateMetadataDisplay(exifData) {
            const make = EXIF.getTag(exifData, "Make") || "";
            const model = EXIF.getTag(exifData, "Model") || "Unbekannt";
            const date = EXIF.getTag(exifData, "DateTimeOriginal") || EXIF.getTag(exifData, "DateTime") || "-";
            const software = EXIF.getTag(exifData, "Software") || "-";

            // Photo Settings (ISO, F, Exp)
            const iso = EXIF.getTag(exifData, "ISOSpeedRatings");
            const fnum = EXIF.getTag(exifData, "FNumber");
            const exp = EXIF.getTag(exifData, "ExposureTime");

            let settingsText = [];
            if(fnum) settingsText.push(`f/${fnum}`);
            if(exp) {
                // Format Exposure Time nicely (e.g. 1/100)
                if(exp < 1) settingsText.push(`1/${Math.round(1/exp)}s`);
                else settingsText.push(`${exp}s`);
            }
            if(iso) settingsText.push(`ISO${iso}`);

            metaModel.textContent = `${make} ${model}`.trim();
            metaDate.textContent = date;
            metaSoft.textContent = software;
            metaSettings.textContent = settingsText.length > 0 ? settingsText.join(" • ") : "Keine Daten";

            metadataSection.classList.remove('hidden');
        }

        // Convert DMS (Degrees Minutes Seconds) to Decimal
        function convertDMSToDD(dms, ref) {
            let dd = dms[0] + dms[1]/60 + dms[2]/3600;
            if (ref === "S" || ref === "W") {
                dd = dd * -1;
            }
            return dd;
        }

        function showMap(lat, lng) {
            mapWrapper.classList.remove('hidden');
            mapWrapper.classList.add('flex');

            latDisplay.textContent = lat.toFixed(6);
            lngDisplay.textContent = lng.toFixed(6);

            // Set Google Maps Link
            gmapsLink.href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;

            // Initialize Map if not exists
            if(!map) {
                map = L.map('map').setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
            } else {
                map.setView([lat, lng], 13);
                // Remove old markers
                map.eachLayer((layer) => {
                    if(layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
            }

            // Add Marker
            L.marker([lat, lng]).addTo(map)
                .bindPopup("Foto Aufnahmeort")
                .openPopup();

            // Trigger a resize because container was hidden
            setTimeout(() => { map.invalidateSize(); }, 100);
        }

        function cleanImage() {
            if (!originalFile) return;

            cleanBtn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Reinige...';

            const reader = new FileReader();
            reader.readAsDataURL(originalFile);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = "SAFE_" + originalFile.name.replace(/\.[^/.]+$/, "") + ".jpg";
                        link.click();

                        cleanBtn.innerHTML = '<i class="ph ph-check"></i> Erledigt!';
                        setTimeout(() => {
                             cleanBtn.innerHTML = '<i class="ph ph-eraser"></i> GPS & Daten löschen';
                        }, 2000);

                    }, 'image/jpeg', 0.95);
                };
            };
        }

        function resetUI() {
            mapWrapper.classList.add('hidden');
            mapWrapper.classList.remove('flex');
            safeState.classList.add('hidden');
            metadataSection.classList.add('hidden');
            initialState.classList.remove('hidden');
            cleanBtn.disabled = true;
            if(map) {
                // optional: map.remove(); map = null;
            }
        }
    </script>
</body>
</html>