<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Dokument – Druckansicht</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* A4 zentriert */

        body {
            background: #e5e7eb;
            margin: 0;
            font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        }

        .page {
            width: 210mm;
            min-height: 297mm;
            margin: 12mm auto;
            background: #ffffff;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
            padding: 18mm 18mm 16mm 18mm;
            box-sizing: border-box;
            position: relative;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16mm;
        }

        .logo-box img {
            max-height: 28mm;
            max-width: 60mm;
            object-fit: contain;
        }

        .title-box {
            text-align: right;
        }

        .title-main {
            font-size: 18pt;
            font-weight: 600;
            margin-bottom: 4mm;
        }

        .title-sub {
            font-size: 10pt;
            color: #4b5563;
        }

        .two-column {
            display: flex;
            gap: 10mm;
            margin-bottom: 10mm;
        }

        .party-box {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 4mm 5mm;
            font-size: 9pt;
        }

        .party-title {
            font-weight: 600;
            margin-bottom: 1mm;
            font-size: 9pt;
        }

        .party-text {
            white-space: pre-line;
        }

        .meta-row {
            display: flex;
            gap: 4mm;
            margin-top: 6mm;
            font-size: 9pt;
        }

        .meta-box {
            flex: 1 1 0;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 3mm 4mm;
        }

        .meta-label {
            font-size: 8pt;
            color: #6b7280;
            margin-bottom: 1mm;
        }

        .meta-value {
            font-size: 9.5pt;
            font-weight: 500;
        }

        table#itemsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6mm;
            font-size: 9pt;
        }

        table#itemsTable th,
        table#itemsTable td {
            border: 1px solid #e5e7eb;
            padding: 2mm 2.5mm;
        }

        table#itemsTable th {
            background: #f3f4f6;
            font-weight: 600;
            font-size: 8.5pt;
        }

        table#itemsTable td.num {
            text-align: right;
            white-space: nowrap;
        }

        .sum-table {
            width: 60mm;
            margin-left: auto;
            margin-top: 4mm;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .sum-table td {
            padding: 2mm 2.5mm;
        }

        .sum-table tr td:first-child {
            text-align: right;
            color: #4b5563;
            font-size: 8.5pt;
        }

        .sum-table tr td:last-child {
            text-align: right;
            min-width: 26mm;
            border-bottom: 1px solid #e5e7eb;
        }

        .notes-section {
            margin-top: 10mm;
            font-size: 8.5pt;
        }

        .note-box {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 3mm 4mm;
            margin-top: 2mm;
            white-space: pre-line;
        }

        .bank-row {
            display: flex;
            gap: 6mm;
            margin-top: 12mm;
            font-size: 8.5pt;
        }

        .bank-row .label {
            font-weight: 600;
            margin-right: 1mm;
        }

        .footer {
            margin-top: 10mm;
            font-size: 7.5pt;
            color: #6b7280;
            text-align: center;
        }

        .paid-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -40%) rotate(-15deg);
            font-size: 32pt;
            font-weight: 800;
            color: rgba(16, 185, 129, 0.12);
            border: 3px solid rgba(16, 185, 129, 0.25);
            padding: 6mm 14mm;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: none;
        }

        .paid-info {
            margin-top: 4mm;
            font-size: 8.5pt;
            font-style: italic;
            color: #059669;
        }

        @media print {
            body {
                background: #ffffff;
            }
            .page {
                margin: 0;
                box-shadow: none;
            }
            .print-controls {
                display: none;
            }
        }

        .print-controls {
            text-align: center;
            padding: 6mm 0 0;
            font-size: 9pt;
        }

        .print-controls button {
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            background: #374151;
            color: #f9fafb;
            cursor: pointer;
        }

        .print-controls button:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
<div class="print-controls">
    <button onclick="window.print()">Jetzt drucken / als PDF speichern</button>
</div>

<div class="page">
    <div class="paid-stamp" id="paidStamp" style="display:none;">BEZAHLT</div>
    <div class="header-row">
        <div class="logo-box">
            <img id="logoImg" alt="Logo">
        </div>
        <div class="title-box">
            <div class="title-main" id="docTitle">Dokument</div>
            <div class="title-sub">Erstellt mit dem Warenschmiede Dokumenten-Tool Light</div>
        </div>
    </div>

    <div class="two-column">
        <div class="party-box">
            <div class="party-title">Anbieter</div>
            <div class="party-text" id="anbieterText"></div>
        </div>
        <div class="party-box">
            <div class="party-title">Kunde</div>
            <div class="party-text" id="kundeText"></div>
        </div>
    </div>

    <div class="meta-row">
        <div class="meta-box">
            <div class="meta-label" id="metaDocNumberLabel">Dokument-Nr.</div>
            <div class="meta-value" id="metaDocNumber"></div>
        </div>
        <div class="meta-box">
            <div class="meta-label">Datum</div>
            <div class="meta-value" id="metaDocDate"></div>
        </div>
        <div class="meta-box">
            <div class="meta-label">Leistungsdatum</div>
            <div class="meta-value" id="metaService"></div>
        </div>
    </div>

    <div class="meta-row">
        <div class="meta-box">
            <div class="meta-label">Kunden-Bestellnummer</div>
            <div class="meta-value" id="metaCustomerOrder"></div>
        </div>
        <div class="meta-box">
            <div class="meta-label">Zahlungsziel / Hinweis</div>
            <div class="meta-value" id="metaPaymentTerms"></div>
        </div>
    </div>

    <div id="referenceOfferBox" style="margin-top: 4mm; font-size: 8.5pt; display: none;">
        <strong>Bezug auf Angebot:</strong>
        <span id="referenceOfferText"></span>
    </div>

    <table id="itemsTable">
        <thead>
        <tr>
            <th style="width:10mm;">Pos.</th>
            <th>Beschreibung</th>
            <th style="width:18mm;">Menge</th>
            <th style="width:20mm;">Einheit</th>
            <th class="col-price" style="width:26mm;">Einzelpreis</th>
            <th class="col-total" style="width:26mm;">Summe</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <table class="sum-table">
        <tr>
            <td>Zwischensumme netto:</td>
            <td id="sumNetOut">0,00 €</td>
        </tr>
        <tr id="rowVat">
            <td>Gesamt MwSt:</td>
            <td id="sumVatOut">0,00 €</td>
        </tr>
        <tr>
            <td><strong>Summe brutto:</strong></td>
            <td id="sumGrossOut"><strong>0,00 €</strong></td>
        </tr>
    </table>

    <div class="notes-section">
        <div class="note-box" id="noteBox">
            <strong>Hinweis / Notiz</strong><br>
            <span id="noteText"></span>
        </div>

        <div class="paid-info" id="paidInfo" style="display:none;"></div>

        <div class="bank-row" id="bankRow">
            <div><span class="label">Bank:</span> <span id="bankNameOut"></span></div>
            <div><span class="label">IBAN:</span> <span id="bankIbanOut"></span></div>
            <div><span class="label">BIC:</span> <span id="bankBicOut"></span></div>
        </div>

        <div class="footer" id="footerText">
            Dokument erstellt mit dem Warenschmiede Dokumenten-Tool Light – Made in Germany.
        </div>
    </div>
</div>

<script>
(function() {
    const STORAGE_KEY_PRINT = "dokuLight-print-data";
    const STORAGE_KEY_LOGO = "dokuLight-logo";

    function formatCurrency(amount, currencyCode) {
        const code = currencyCode || "EUR";
        try {
            return new Intl.NumberFormat("de-DE", {
                style: "currency",
                currency: code
            }).format(amount);
        } catch (_) {
            return amount.toFixed(2) + " " + code;
        }
    }

    function parseNumber(text) {
        if (text == null) return 0;
        if (typeof text === "number") return text || 0;

        let t = String(text).trim();
        if (!t) return 0;

        const hasComma = t.indexOf(",") !== -1;

        if (hasComma) {
            // Deutsch: 1.234,56
            t = t.replace(/\./g, "").replace(",", ".");
        }

        // Alle Zeichen außer Ziffern, Punkt und Minus entfernen
        t = t.replace(/[^0-9.\-]/g, "");
        if (!t) return 0;

        const n = parseFloat(t);
        return isNaN(n) ? 0 : n;
    }

    function textOrDash(value) {
        return value ? value : "–";
    }

    function buildPartyText(name, company, street, zipCity, email, extraLine) {
        const parts = [];
        if (company) parts.push(company);
        if (name) parts.push(name);
        if (street) parts.push(street);
        if (zipCity) parts.push(zipCity);
        if (email) parts.push(email);
        if (extraLine) parts.push(extraLine);
        return parts.join("\n");
    }

    function loadLogo() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY_LOGO);
            if (!raw) return;
            const img = document.getElementById("logoImg");
            if (img) img.src = raw;
        } catch (e) {
            console.warn("Logo konnte nicht geladen werden:", e);
        }
    }

    function main() {
        let data;
        try {
            const raw = localStorage.getItem(STORAGE_KEY_PRINT);
            if (!raw) {
                alert("Keine Druckdaten gefunden.");
                return;
            }
            data = JSON.parse(raw);
        } catch (e) {
            console.error(e);
            alert("Druckdaten konnten nicht gelesen werden.");
            return;
        }

        const currency = data.currency || "EUR";
        const docType = (data.docTypeForPrint || data.docType || "rechnung").toLowerCase();

        let title = "Dokument";
        let docNumberLabel = "Dokument-Nr.";

        if (docType === "rechnung") {
            title = "Rechnung";
            docNumberLabel = "Rechnungs-Nr.";
        } else if (docType === "angebot") {
            title = "Angebot";
            docNumberLabel = "Angebots-Nr.";
        } else if (docType === "lieferschein") {
            title = "Lieferschein";
            docNumberLabel = "Lieferschein-Nr.";
        } else if (docType === "bestellbestätigung" || docType === "bestellbestaetigung") {
            title = "Bestellbestätigung";
            docNumberLabel = "Bestellbestätigung-Nr.";
        } else if (docType === "zahlungserinnerung") {
            title = "Zahlungserinnerung";
            docNumberLabel = "Zahlungserinnerungs-Nr.";
        } else if (docType === "mahnung") {
            title = "Mahnung";
            docNumberLabel = "Mahnungs-Nr.";
        }

        document.title = title + " – Druckansicht";
        document.getElementById("docTitle").textContent = title;
        const docLabelEl = document.getElementById("metaDocNumberLabel");
        if (docLabelEl) docLabelEl.textContent = docNumberLabel;

        // Footer-Text abhängig vom Dokumenttyp
        const footerEl = document.getElementById("footerText");
        if (footerEl) {
            if (docType === "lieferschein") {
                footerEl.textContent =
                    "Dies ist ein Lieferschein und keine Rechnung. Dokument erstellt mit dem Warenschmiede Dokumenten-Tool Light – Made in Germany.";
            } else if (docType === "rechnung") {
                footerEl.textContent =
                    "Diese Rechnung wurde mit dem Warenschmiede Dokumenten-Tool Light erstellt. – Made in Germany.";
            } else if (docType === "angebot") {
                footerEl.textContent =
                    "Dieses Angebot wurde mit dem Warenschmiede Dokumenten-Tool Light erstellt. – Made in Germany.";
            } else {
                footerEl.textContent =
                    "Dokument erstellt mit dem Warenschmiede Dokumenten-Tool Light – Made in Germany.";
            }
        }

        // Anbieter / Kunde
        document.getElementById("anbieterText").innerHTML =
            buildPartyText(
                data.vendorName,
                data.vendorCompany,
                data.vendorStreet,
                data.vendorZipCity,
                data.vendorEmail,
                data.vendorTaxNote
            ).replace(/\n/g, "<br>");

        document.getElementById("kundeText").innerHTML =
            buildPartyText(
                data.customerName,
                data.customerCompany,
                data.customerStreet,
                data.customerZipCity,
                data.customerEmail,
                data.customerNumber ? "Kundennummer: " + data.customerNumber : ""
            ).replace(/\n/g, "<br>");

        // Meta-Daten
        document.getElementById("metaDocNumber").textContent = textOrDash(data.docNumber);
        document.getElementById("metaDocDate").textContent = textOrDash(data.docDate);

        let serviceText = "";
        if (data.serviceDateFrom && data.serviceDateTo) {
            serviceText = "von " + data.serviceDateFrom + " bis " + data.serviceDateTo;
        } else if (data.serviceDateFrom) {
            serviceText = data.serviceDateFrom;
        } else if (data.serviceDateTo) {
            serviceText = data.serviceDateTo;
        } else {
            serviceText = "–";
        }
        document.getElementById("metaService").textContent = serviceText;

        document.getElementById("metaCustomerOrder").textContent =
            textOrDash(data.customerOrderNumber);
        document.getElementById("metaPaymentTerms").textContent =
            textOrDash(data.paymentTerms);

        // Bezug auf Angebot (optional) – nur auf Rechnungen anzeigen
        const refOffer = (data.referenceOffer || "").trim();
        if (docType === "rechnung" && refOffer) {
            const refBox = document.getElementById("referenceOfferBox");
            const refText = document.getElementById("referenceOfferText");
            if (refBox && refText) {
                refText.textContent = refOffer;
                refBox.style.display = "block";
            }
        }

        // Positionen & Summen
        const tbody = document.querySelector("#itemsTable tbody");
        tbody.innerHTML = "";
        let pos = 1;
        let sumNet = 0;
        let sumVat = 0;
        let sumGross = 0;

        if (Array.isArray(data.items)) {
            data.items.forEach(item => {
                const name = item.name || "";
                const desc = item.desc || "";
                const qty = parseNumber(item.qty);
                const unitText = item.unit || "";
                const price = parseNumber(item.price);
                const vatRate = data.isKleinunternehmer ? 0 : parseNumber(item.vat || 0);

                if (!name && !desc && !qty && !price) return; // leere Zeilen überspringen

                const net = qty * price;
                const vat = net * (vatRate / 100);
                const gross = net + vat;

                sumNet += net;
                sumVat += vat;
                sumGross += gross;

                const tr = document.createElement("tr");

                function td(text, cls) {
                    const td = document.createElement("td");
                    if (cls) td.className = cls;
                    td.textContent = text;
                    return td;
                }

                tr.appendChild(td(String(pos++)));
                tr.appendChild(td(name + (desc ? " – " + desc : "")));
                tr.appendChild(td(qty ? String(qty) : "", "num"));
                tr.appendChild(td(unitText));
                tr.appendChild(td(price ? formatCurrency(price, currency) : "", "num col-price"));
                tr.appendChild(td(formatCurrency(gross, currency), "num col-total"));

                tbody.appendChild(tr);
            });
        }

        document.getElementById("sumNetOut").textContent =
            formatCurrency(sumNet, currency);

        if (data.isKleinunternehmer) {
            document.getElementById("rowVat").style.display = "none";
            sumVat = 0;
        } else {
            document.getElementById("rowVat").style.display = "";
            document.getElementById("sumVatOut").textContent =
                formatCurrency(sumVat, currency);
        }

        document.getElementById("sumGrossOut").textContent =
            formatCurrency(sumGross, currency);

        // Notiz
        const note = data.notes || "";
        const noteBox = document.getElementById("noteBox");
        if (note.trim()) {
            document.getElementById("noteText").textContent = note;
        } else {
            noteBox.style.display = "none";
        }

        // Bank
        document.getElementById("bankNameOut").textContent = textOrDash(data.bankName);
        document.getElementById("bankIbanOut").textContent = textOrDash(data.bankIban);
        document.getElementById("bankBicOut").textContent = textOrDash(data.bankBic);

        // Kleinunternehmer-Hinweis im Footer – nur für Dokumente mit Preisen relevant
        if (data.isKleinunternehmer && docType !== "lieferschein") {
            const footerEl2 = document.getElementById("footerText");
            if (footerEl2) {
                footerEl2.textContent =
                    "Gemäß §19 UStG wird keine Umsatzsteuer ausgewiesen. Dokument erstellt mit dem Warenschmiede Dokumenten-Tool Light – Made in Germany.";
            }
        }

        // Bezahlt-Stempel NUR bei Rechnung
        if (docType === "rechnung" && data.isPaid) {
            const stamp = document.getElementById("paidStamp");
            const info = document.getElementById("paidInfo");
            if (stamp) stamp.style.display = "block";
            if (info) {
                info.style.display = "block";
                info.textContent = "Bereits bezahlt am " +
                    (data.paidDate || "unbekanntem Datum") + ".";
            }
        }

        // Lieferschein: Spalten Preise/Summen + Gesamtsummen ausblenden
        if (docType === "lieferschein") {
            document.querySelectorAll(".col-price, .col-total").forEach(el => {
                el.style.display = "none";
            });
            const sumTable = document.querySelector(".sum-table");
            if (sumTable) sumTable.style.display = "none";
        }

        // Logo laden
        loadLogo();
    }

    document.addEventListener("DOMContentLoaded", main);
})();
</script>
</body>
</html>
