<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio to Video Converter (Network Edition)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- FFmpeg Wrapper v0.9.8 -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.9.8/dist/ffmpeg.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .drop-zone {
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23475569' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .drop-zone:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        .drop-zone.active {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Server Switcher -->
    <div class="absolute top-4 right-4 flex gap-2 text-xs">
        <span class="text-slate-500 py-1">Engine Server:</span>
        <button onclick="setServer('unpkg')" id="btn-unpkg" class="bg-blue-600 text-white px-2 py-1 rounded">Server A (Unpkg)</button>
        <button onclick="setServer('jsdelivr')" id="btn-jsdelivr" class="bg-slate-700 text-slate-300 px-2 py-1 rounded hover:bg-slate-600">Server B (jsDelivr)</button>
    </div>

    <div class="w-full max-w-2xl bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700 p-8 space-y-8">
        
        <!-- Header -->
        <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-pink-600/20 text-pink-500 mb-4">
                <i class="ph ph-network text-4xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-white">Audio zu Video</h1>
            <p class="text-slate-400 text-sm mt-2">Network Edition (v0.9.8)</p>
        </div>

        <!-- 1. Upload Audio -->
        <div class="space-y-2">
            <label class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                <i class="ph ph-music-note text-blue-400"></i> 1. MP3 Datei
            </label>
            <div id="audio-drop" class="drop-zone h-24 rounded-xl flex flex-col items-center justify-center cursor-pointer relative group">
                <input type="file" id="audio-input" accept="audio/mp3, audio/mpeg, audio/wav" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                <div id="audio-label" class="text-center pointer-events-none">
                    <p class="text-slate-400 text-sm group-hover:text-blue-400 transition-colors">MP3 hier ablegen</p>
                </div>
            </div>
        </div>

        <!-- 2. Upload Image -->
        <div class="space-y-2">
            <label class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                <i class="ph ph-image text-emerald-400"></i> 2. Bild (16:9 empfohlen)
            </label>
            <div id="image-drop" class="drop-zone h-24 rounded-xl flex flex-col items-center justify-center cursor-pointer relative group">
                <input type="file" id="image-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                <div id="image-label" class="text-center pointer-events-none">
                    <p class="text-slate-400 text-sm group-hover:text-emerald-400 transition-colors">Bild hier ablegen</p>
                </div>
                <img id="image-preview" class="absolute inset-0 w-full h-full object-cover rounded-xl opacity-50 hidden pointer-events-none">
            </div>
        </div>

        <!-- 3. Action Area -->
        <div class="pt-4 border-t border-slate-700">
            
            <!-- Status / Log Box -->
            <div id="status-box" class="hidden mb-4 bg-black/50 rounded-lg p-3 text-xs font-mono text-cyan-400 border border-slate-600 h-24 overflow-y-auto">
                <div id="log-content">Warte auf Start...</div>
            </div>

            <!-- Progress Bar Engine Download -->
            <div id="dl-progress-container" class="hidden mb-4">
                <div class="flex justify-between text-xs text-slate-400 mb-1">
                    <span>Lade Video-Engine (25MB)...</span>
                    <span id="dl-percent">0%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-1.5">
                    <div id="dl-bar" class="bg-pink-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <button id="convert-btn" onclick="startProcess()" disabled class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 text-lg">
                <i class="ph ph-play"></i> Starten
            </button>

            <!-- Download Link -->
            <a id="download-link" class="hidden w-full mt-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 text-center cursor-pointer">
                <i class="ph ph-download-simple text-xl"></i> Video Speichern
            </a>
        </div>

    </div>

    <script>
        // --- Config ---
        let currentServer = 'unpkg';
        const servers = {
            unpkg: 'https://unpkg.com/@ffmpeg/core@0.9.8/dist/ffmpeg-core.js',
            jsdelivr: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.9.8/dist/ffmpeg-core.js'
        };

        // --- Elements ---
        const audioInput = document.getElementById('audio-input');
        const audioLabel = document.getElementById('audio-label');
        const imageInput = document.getElementById('image-input');
        const imageLabel = document.getElementById('image-label');
        const imagePreview = document.getElementById('image-preview');
        const convertBtn = document.getElementById('convert-btn');
        const statusBox = document.getElementById('status-box');
        const logContent = document.getElementById('log-content');
        const dlContainer = document.getElementById('dl-progress-container');
        const dlBar = document.getElementById('dl-bar');
        const dlPercent = document.getElementById('dl-percent');
        const downloadLink = document.getElementById('download-link');

        let audioFile = null;
        let imageFile = null;
        let ffmpeg = null;

        // --- Server Switcher ---
        function setServer(srv) {
            currentServer = srv;
            document.getElementById('btn-unpkg').className = srv === 'unpkg' ? 'bg-blue-600 text-white px-2 py-1 rounded' : 'bg-slate-700 text-slate-300 px-2 py-1 rounded hover:bg-slate-600';
            document.getElementById('btn-jsdelivr').className = srv === 'jsdelivr' ? 'bg-blue-600 text-white px-2 py-1 rounded' : 'bg-slate-700 text-slate-300 px-2 py-1 rounded hover:bg-slate-600';
            log(`Server gewechselt zu: ${srv.toUpperCase()}`);
        }

        // --- Logger ---
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div><span class="text-slate-500">[${time}]</span> ${msg}</div>`;
            statusBox.scrollTop = statusBox.scrollHeight;
        }

        // --- File Inputs ---
        audioInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                audioFile = file;
                audioLabel.innerHTML = `<span class="text-white font-bold">${file.name}</span>`;
                checkReady();
            }
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                imageFile = file;
                imageLabel.classList.add('hidden');
                imagePreview.src = URL.createObjectURL(file);
                imagePreview.classList.remove('hidden');
                checkReady();
            }
        });

        function checkReady() {
            if(audioFile && imageFile) {
                convertBtn.disabled = false;
                convertBtn.classList.add('animate-pulse');
            }
        }

        // --- Main Process ---
        async function startProcess() {
            convertBtn.disabled = true;
            convertBtn.classList.remove('animate-pulse');
            statusBox.classList.remove('hidden');
            downloadLink.classList.add('hidden');
            
            try {
                const { createFFmpeg, fetchFile } = FFmpeg;

                if (!ffmpeg) {
                    const coreURL = servers[currentServer];
                    log(`Lade Engine von ${currentServer}...`);
                    dlContainer.classList.remove('hidden');

                    // 1. Manually fetch core to show progress (browser fetch doesn't always show progress for scripts easily, but FFmpeg logger helps)
                    ffmpeg = createFFmpeg({
                        log: true,
                        corePath: coreURL,
                        logger: ({ message }) => {
                            // Try to detect download progress messages from browser if any (rare)
                            // Mostly capture FFmpeg internal logs
                            if(message.includes("frame=") || message.includes("size=")) {
                                // Encoding progress
                                log(message); 
                            }
                        },
                        progress: ({ ratio }) => {
                            // This is encoding progress usually
                            const p = Math.round(ratio * 100);
                            convertBtn.innerText = `Erstelle Video: ${p}%`;
                        }
                    });

                    // Fake download progress visualizer (since we can't hook into script tag download easily)
                    let fakeP = 0;
                    const fakeInterval = setInterval(() => {
                        if(fakeP < 90) {
                            fakeP += Math.random() * 5;
                            dlBar.style.width = Math.min(fakeP, 90) + "%";
                            dlPercent.innerText = Math.round(Math.min(fakeP, 90)) + "%";
                        }
                    }, 500);

                    await ffmpeg.load();
                    
                    clearInterval(fakeInterval);
                    dlBar.style.width = "100%";
                    dlPercent.innerText = "100%";
                    log("Engine geladen! (v0.9.8)");
                    setTimeout(() => dlContainer.classList.add('hidden'), 1000);
                }

                // 2. Write Files
                log("Kopiere Dateien...");
                ffmpeg.FS('writeFile', 'input.mp3', await fetchFile(audioFile));
                ffmpeg.FS('writeFile', 'input.jpg', await fetchFile(imageFile));

                // 3. Run
                log("Starte Encoding...");
                
                // Optimized command for YouTube (Fast decode/encode)
                // -shortest: Stop when shortest input (audio) ends (since image loops forever)
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', 'input.jpg',
                    '-i', 'input.mp3',
                    '-c:a', 'copy', // Copy audio (super fast, no re-encoding of MP3)
                    '-c:v', 'libx264', // Encode Video
                    '-tune', 'stillimage',
                    '-pix_fmt', 'yuv420p',
                    '-shortest',
                    'output.mp4'
                );

                log("Encoding fertig!");

                // 4. Output
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const blob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = `video_${audioFile.name.split('.')[0]}.mp4`;
                downloadLink.classList.remove('hidden');
                
                convertBtn.innerText = "Fertig!";
                convertBtn.classList.add('bg-emerald-600');

                // Cleanup
                ffmpeg.FS('unlink', 'input.mp3');
                ffmpeg.FS('unlink', 'input.jpg');
                ffmpeg.FS('unlink', 'output.mp4');

            } catch (err) {
                console.error(err);
                log(`<span class="text-red-400">FEHLER: ${err.message}</span>`);
                alert("Fehler! Wenn es hängt, versuche oben rechts 'Server B' auszuwählen.");
                convertBtn.innerText = "Fehler - Neu versuchen";
                convertBtn.disabled = false;
            }
        }
    </script>
</body>
</html>