<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio to Video Converter (Infinity)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- FFmpeg Wrapper (v0.11.6) -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .drop-zone {
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23475569' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .drop-zone:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        .drop-zone.active {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700 p-8 space-y-8">
        
        <!-- Header -->
        <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-600/20 text-indigo-500 mb-4">
                <i class="ph ph-infinity text-4xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-white">Audio zu Video</h1>
            <p class="text-slate-400 text-sm mt-2">Infinity Edition (Manual ST-Loader)</p>
        </div>

        <!-- 1. Upload Audio -->
        <div class="space-y-2">
            <label class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                <i class="ph ph-music-note text-blue-400"></i> 1. MP3 Datei
            </label>
            <div id="audio-drop" class="drop-zone h-24 rounded-xl flex flex-col items-center justify-center cursor-pointer relative group">
                <input type="file" id="audio-input" accept="audio/mp3, audio/mpeg, audio/wav" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                <div id="audio-label" class="text-center pointer-events-none">
                    <p class="text-slate-400 text-sm group-hover:text-blue-400 transition-colors">MP3 hier ablegen</p>
                </div>
            </div>
        </div>

        <!-- 2. Upload Image -->
        <div class="space-y-2">
            <label class="text-sm font-bold text-slate-300 uppercase flex items-center gap-2">
                <i class="ph ph-image text-emerald-400"></i> 2. Bild (16:9 empfohlen)
            </label>
            <div id="image-drop" class="drop-zone h-24 rounded-xl flex flex-col items-center justify-center cursor-pointer relative group">
                <input type="file" id="image-input" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                <div id="image-label" class="text-center pointer-events-none">
                    <p class="text-slate-400 text-sm group-hover:text-emerald-400 transition-colors">Bild hier ablegen</p>
                </div>
                <img id="image-preview" class="absolute inset-0 w-full h-full object-cover rounded-xl opacity-50 hidden pointer-events-none">
            </div>
        </div>

        <!-- 3. Action Area -->
        <div class="pt-4 border-t border-slate-700">
            
            <!-- Download Status -->
            <div id="dl-container" class="hidden mb-4 space-y-3 p-4 bg-slate-900 rounded-lg border border-slate-600">
                <div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Lade Engine Core (JS)...</span>
                        <span id="js-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5">
                        <div id="js-bar" class="bg-yellow-500 h-1.5 rounded-full transition-all duration-100" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Lade Engine Binary (WASM)...</span>
                        <span id="wasm-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5">
                        <div id="wasm-bar" class="bg-indigo-500 h-1.5 rounded-full transition-all duration-100" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Encoding Progress -->
            <div id="progress-container" class="hidden mt-4 space-y-2">
                <div class="flex justify-between text-xs text-slate-400">
                    <span id="status-text">Initialisiere...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2.5 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <button id="convert-btn" onclick="startProcess()" disabled class="w-full bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 text-lg">
                <i class="ph ph-play"></i> Starten
            </button>

            <!-- Download Link -->
            <a id="download-link" class="hidden w-full mt-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 text-center cursor-pointer">
                <i class="ph ph-download-simple text-xl"></i> Video Speichern
            </a>
        </div>

    </div>

    <!-- Live Log Area -->
    <div class="w-full max-w-2xl mt-4">
        <p class="text-xs text-slate-500 uppercase font-bold mb-2">System Protokoll:</p>
        <div id="log-area" class="w-full h-48 bg-black rounded-lg border border-slate-700 p-3 text-[10px] font-mono text-indigo-400 overflow-y-auto whitespace-pre-wrap">Bereit f체r Start.</div>
    </div>

    <script>
        const audioInput = document.getElementById('audio-input');
        const audioLabel = document.getElementById('audio-label');
        const imageInput = document.getElementById('image-input');
        const imageLabel = document.getElementById('image-label');
        const imagePreview = document.getElementById('image-preview');
        const convertBtn = document.getElementById('convert-btn');
        const dlContainer = document.getElementById('dl-container');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');
        const downloadLink = document.getElementById('download-link');
        const logArea = document.getElementById('log-area');

        let audioFile = null;
        let imageFile = null;
        let ffmpeg = null;

        // URLs for v0.11.6 Single Threaded (WICHTIG: core-st!)
        const URL_JS = 'https://unpkg.com/@ffmpeg/core-st@0.11.6/dist/ffmpeg-core.js';
        const URL_WASM = 'https://unpkg.com/@ffmpeg/core-st@0.11.6/dist/ffmpeg-core.wasm';

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${time}] ${msg}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // --- File Handling ---
        audioInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                audioFile = file;
                audioLabel.innerHTML = `<span class="text-white font-bold">${file.name}</span>`;
                checkReady();
            }
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                imageFile = file;
                imageLabel.classList.add('hidden');
                imagePreview.src = URL.createObjectURL(file);
                imagePreview.classList.remove('hidden');
                checkReady();
            }
        });

        function checkReady() {
            if(audioFile && imageFile) {
                convertBtn.disabled = false;
                convertBtn.classList.add('animate-pulse');
            }
        }

        // --- Robust Downloader ---
        async function fetchWithProgress(url, barId, percentId) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status} beim Laden von ${url}`);
            
            // Handle gzip/compression where content-length might be missing or smaller than body
            const contentLength = response.headers.get('content-length');
            const total = contentLength ? parseInt(contentLength, 10) : 0;
            let loaded = 0;

            const reader = response.body.getReader();
            const chunks = [];

            while(true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
                loaded += value.length;
                
                if (total) {
                    // Cap at 100% to avoid visual glitches if size is mismatched
                    const pct = Math.min(100, Math.round((loaded / total) * 100));
                    document.getElementById(barId).style.width = pct + "%";
                    document.getElementById(percentId).innerText = pct + "%";
                } else {
                    // Indeterminate state if no size header
                    document.getElementById(percentId).innerText = "Lade...";
                }
            }

            // Force 100% visual completion
            document.getElementById(barId).style.width = "100%";
            document.getElementById(percentId).innerText = "100%";

            return new Blob(chunks);
        }

        // --- Main Process ---
        async function startProcess() {
            convertBtn.disabled = true;
            convertBtn.classList.remove('animate-pulse');
            dlContainer.classList.remove('hidden');
            progressContainer.classList.add('hidden');
            downloadLink.classList.add('hidden');
            
            try {
                const { createFFmpeg, fetchFile } = FFmpeg;

                if (!ffmpeg) {
                    log("--- Start Engine Download (Manual) ---");
                    
                    // 1. Download WASM (Single Threaded)
                    log(`Lade WASM: ${URL_WASM}`);
                    const wasmBlob = await fetchWithProgress(URL_WASM, 'wasm-bar', 'wasm-percent');
                    const wasmUrl = URL.createObjectURL(wasmBlob);
                    
                    // 2. Download JS (Single Threaded)
                    log(`Lade JS: ${URL_JS}`);
                    const jsBlob = await fetchWithProgress(URL_JS, 'js-bar', 'js-percent');
                    
                    // Create Blob URL for JS
                    // Note: modern createFFmpeg allows blob URLs for corePath
                    const jsUrl = URL.createObjectURL(jsBlob);

                    // 3. Init FFmpeg
                    log("Initialisiere FFmpeg mit lokalen Blobs...");
                    
                    ffmpeg = createFFmpeg({ 
                        log: true,
                        corePath: jsUrl, // Load the JS we just downloaded
                        // We provide a worker handler to intercept requests if needed, 
                        // but usually v0.11.6 finds the wasm if we configure it right.
                        // However, with Blob URLs, relative paths break.
                        // WE NEED TO TELL IT WHERE THE WASM IS.
                        // Unfortunately createFFmpeg v0.11.x config is tricky with blobs.
                        // WORKAROUND: We assume standard loading first. 
                        // If we use the Blob approach for corePath, we must ensure it finds the WASM.
                        // We can't easily patch the WASM path into the JS blob without parsing it.
                        // SO: We use the direct URL for corePath, but rely on browser cache since we just fetched it.
                        // Wait... we can patch it!
                    });
                    
                    // PATCHING STRATEGY:
                    // Let's modify the JS blob content to point to our WASM blob
                    let jsText = await new Response(jsBlob).text();
                    // The core script usually looks for "ffmpeg-core.wasm"
                    // We replace that string with our blob URL
                    // This is specific to v0.11.x structure
                    if(jsText.includes("ffmpeg-core.wasm")) {
                        log("Patche WASM Pfad im Code...");
                        jsText = jsText.replace(/ffmpeg-core\.wasm/g, wasmUrl);
                    }
                    
                    const patchedJsBlob = new Blob([jsText], { type: 'application/javascript' });
                    const patchedJsUrl = URL.createObjectURL(patchedJsBlob);
                    
                    // Re-create instance with patched JS
                    ffmpeg = createFFmpeg({
                        log: true,
                        corePath: patchedJsUrl,
                        logger: ({ message }) => {
                            if(message.includes("frame=") || message.includes("size=")) log("FFmpeg: " + message);
                        },
                        progress: ({ ratio }) => {
                            const percent = Math.round(ratio * 100);
                            progressBar.style.width = `${percent}%`;
                            document.getElementById('progress-percent').textContent = `${percent}%`;
                            if(percent >= 100) statusText.textContent = "Finalisiere...";
                            else statusText.textContent = "Verarbeite...";
                        }
                    });

                    await ffmpeg.load();
                    dlContainer.classList.add('hidden');
                    log("Engine l채uft! (Single Threaded)");
                }

                progressContainer.classList.remove('hidden');
                
                log("Schreibe Input-Dateien...");
                ffmpeg.FS('writeFile', 'input.mp3', await fetchFile(audioFile));
                ffmpeg.FS('writeFile', 'input.jpg', await fetchFile(imageFile));

                log("Encoding Prozess l채uft... (Single Core Mode)");
                statusText.textContent = "Encoding l채uft...";

                // Optimized command
                await ffmpeg.run(
                    '-loop', '1',
                    '-i', 'input.jpg',
                    '-i', 'input.mp3',
                    '-c:a', 'copy', // Copy audio stream directly
                    '-c:v', 'libx264', 
                    '-tune', 'stillimage', 
                    '-pix_fmt', 'yuv420p', 
                    '-shortest', 
                    '-preset', 'ultrafast',
                    'output.mp4'
                );

                log("Fertig! Generiere Video-Datei...");
                
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const blob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);

                downloadLink.href = url;
                downloadLink.download = `video_${audioFile.name.split('.')[0]}.mp4`;
                downloadLink.classList.remove('hidden');
                
                convertBtn.innerText = "Fertig!";
                convertBtn.classList.add('bg-emerald-600');

                // Cleanup
                try {
                    ffmpeg.FS('unlink', 'input.mp3');
                    ffmpeg.FS('unlink', 'input.jpg');
                    ffmpeg.FS('unlink', 'output.mp4');
                } catch(e) {}

            } catch (err) {
                console.error(err);
                log(`<span class="text-red-400">FEHLER: ${err.message}</span>`);
                alert("Fehler aufgetreten: " + err.message);
                convertBtn.innerText = "Fehler - Neu versuchen";
                convertBtn.disabled = false;
            }
        }
    </script>
</body>
</html>