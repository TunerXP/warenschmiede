<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Master ULTRA - Warenschmiede Tools</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- QR Code Styling Library -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e' }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 3px; }

        /* Map Container */
        #map-picker { height: 250px; width: 100%; border-radius: 0.5rem; z-index: 1; }

        /* Inputs & Transitions */
        .input-label {
            display: flex; align-items: center; gap: 0.25rem;
            font-size: 0.7rem; font-weight: 700;
            text-transform: uppercase; margin-bottom: 0.25rem; letter-spacing: 0.05em;
        }
        .input-field {
            width: 100%; border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; transition: all 0.2s;
            border-width: 1px;
        }
        .input-error { border-color: #ef4444 !important; background-color: #450a0a !important; }
        .error-text { color: #ef4444; font-size: 0.7rem; margin-top: 0.25rem; display: none; }
        .input-error + .error-text { display: block; }

        /* Dark/Light Styles */
        .dark .input-label { color: #94a3b8; }
        .dark .input-field { background-color: #1e293b; border-color: #334155; color: white; }
        .dark .input-field:focus { border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); outline: none; }
        
        html:not(.dark) body { background-color: #f1f5f9; color: #0f172a; }
        html:not(.dark) .input-label { color: #475569; }
        html:not(.dark) .input-field { background-color: #ffffff; border-color: #cbd5e1; color: #0f172a; }
        html:not(.dark) .input-field:focus { border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1); outline: none; }

        .tab-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-btn.active { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dark .tab-btn.active { background-color: #8b5cf6; color: white; border-color: #8b5cf6; }
        html:not(.dark) .tab-btn.active { background-color: #7c3aed; color: white; border-color: #7c3aed; }

        /* Accordion */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-200 transition-colors duration-300">

    <!-- Header -->
    <header class="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 h-16 shrink-0 flex items-center justify-between px-4 sm:px-6 z-20 shadow-sm transition-colors duration-300">
        <div class="flex items-center gap-3 overflow-hidden">
            <div class="bg-gradient-to-br from-violet-600 to-indigo-600 p-2 rounded-lg text-white shadow-lg shadow-violet-500/20 shrink-0">
                <i class="ph ph-qr-code text-xl"></i>
            </div>
            <div class="min-w-0">
                <h1 class="font-bold tracking-wide text-lg leading-tight truncate">QR Master <span class="text-violet-600 dark:text-violet-400 font-black italic text-sm align-top">ULTRA</span></h1>
                <p class="text-[10px] text-slate-500 truncate">Warenschmiede Tools | v3.1 (Web Edition)</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- Home Link -->
            <a href="https://www.warenschmiede.com/downloads.html" target="_blank" class="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-violet-600 dark:hover:text-violet-400 text-xs font-medium px-2 py-1.5 transition rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Downloads">
                <i class="ph ph-download-simple text-lg"></i> <span class="hidden md:inline">Downloads</span>
            </a>
            <a href="https://www.warenschmiede.com/" target="_blank" class="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-violet-600 dark:hover:text-violet-400 text-xs font-medium px-2 py-1.5 transition rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Zur Startseite">
                <i class="ph ph-house text-lg"></i> <span class="hidden md:inline">Home</span>
            </a>

            <!-- Legal Button -->
            <button onclick="toggleLegalModal()" class="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-violet-600 dark:hover:text-violet-400 text-xs font-medium px-2 py-1.5 transition rounded hover:bg-slate-100 dark:hover:bg-slate-800" title="Impressum, Datenschutz & Kontakt">
                <i class="ph ph-scroll text-lg"></i> <span class="hidden md:inline">Rechtliches</span>
            </button>

            <!-- Info Button -->
            <button onclick="toggleInfoModal()" class="flex items-center gap-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs px-3 py-1.5 rounded-full border border-blue-200 dark:border-blue-800 transition hover:bg-blue-200 dark:hover:bg-blue-900/50 ml-1">
                <i class="ph ph-info"></i> <span class="hidden sm:inline">Hilfe</span>
            </button>
            
            <div class="h-6 w-px bg-slate-300 dark:bg-slate-700 mx-1 hidden sm:block"></div>
            
            <!-- Tools -->
            <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 transition" title="Design wechseln">
                <i id="theme-icon" class="ph ph-moon text-xl"></i>
            </button>
            <button onclick="saveDesignPreset()" class="hidden sm:flex items-center gap-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs px-3 py-1.5 rounded border border-slate-200 dark:border-slate-700 transition">
                <i class="ph ph-floppy-disk"></i>
            </button>
            <button onclick="resetDesign()" class="text-slate-400 hover:text-red-500 p-2" title="Reset">
                <i class="ph ph-arrow-counter-clockwise"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden flex-col lg:flex-row">

        <!-- Left Column: Content -->
        <div class="w-full lg:w-1/3 p-4 lg:p-6 border-b lg:border-b-0 lg:border-r border-slate-200 dark:border-slate-800 overflow-y-auto bg-white dark:bg-slate-900/50 transition-colors">
            <h2 class="text-xs font-bold text-violet-600 dark:text-violet-400 uppercase mb-4 flex items-center gap-2">
                <i class="ph ph-pencil-simple"></i> 1. Datentyp & Inhalt
            </h2>

            <!-- Tabs Grid -->
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="setMode('url')" class="tab-btn active flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1">
                    <i class="ph ph-link text-lg"></i> Link
                </button>
                <button onclick="setMode('wifi')" class="tab-btn flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1">
                    <i class="ph ph-wifi-high text-lg"></i> WiFi
                </button>
                <button onclick="setMode('whatsapp')" class="tab-btn flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1">
                    <i class="ph ph-whatsapp-logo text-lg text-green-600 dark:text-green-500"></i> WA
                </button>
                <button onclick="setMode('maps')" class="tab-btn flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1">
                    <i class="ph ph-map-pin text-lg text-red-600 dark:text-red-500"></i> Maps
                </button>
                <button onclick="setMode('sepa')" class="tab-btn flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1">
                    <i class="ph ph-bank text-lg"></i> SEPA
                </button>
                <button onclick="setMode('vcard')" class="tab-btn flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1">
                    <i class="ph ph-user-circle text-lg"></i> vCard
                </button>
                <button onclick="setMode('paypal')" class="tab-btn flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1 ring-1 ring-blue-500/30 bg-blue-500/10 dark:bg-blue-500/10">
                    <i class="ph ph-paypal-logo text-lg text-blue-500 dark:text-blue-400"></i> PayPal
                </button>
                <button onclick="setMode('review')" class="tab-btn flex flex-col items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-1 ring-1 ring-yellow-500/30 bg-yellow-500/10 dark:bg-yellow-500/10">
                    <i class="ph ph-star text-lg text-yellow-500 dark:text-yellow-400"></i> Sterne
                </button>
                <button onclick="setMode('phone')" class="col-span-4 tab-btn flex flex-row items-center justify-center p-2 rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs gap-2">
                    <i class="ph ph-phone text-lg"></i> Telefon / Anruf Direkt
                </button>
            </div>

            <!-- Dynamic Help Text -->
            <div id="mode-description" class="mb-6 p-3 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm text-slate-600 dark:text-slate-300 flex gap-3 items-start transition-colors">
                <i class="ph ph-info text-lg text-violet-500 mt-0.5 shrink-0"></i>
                <span id="desc-text">W√§hle oben eine Funktion aus.</span>
            </div>

            <!-- Input Forms -->
            <div id="forms-container" class="space-y-4">

                <!-- URL -->
                <div id="form-url" class="form-section">
                    <label class="input-label">Webseite URL</label>
                    <input type="url" id="inp-url" class="input-field" placeholder="https://deine-website.de" oninput="validateField(this, 'url'); updateQR()">
                    <p class="error-text">Bitte vollst√§ndige URL mit http(s) eingeben.</p>
                    <p class="text-[10px] text-slate-400 mt-1">Nutze m√∂glichst kurze Links, dann bleibt der QR-Code einfacher und besser scannbar.</p>
                </div>

                <!-- WiFi -->
                <div id="form-wifi" class="form-section hidden space-y-3">
                    <div><label class="input-label">SSID</label><input type="text" id="inp-wifi-ssid" class="input-field" placeholder="Mein WLAN Name" oninput="updateQR()"></div>
                    <div><label class="input-label">Passwort</label><input type="text" id="inp-wifi-pass" class="input-field" placeholder="WLAN Passwort" oninput="updateQR()"></div>
                    <div>
                        <label class="input-label">Verschl√ºsselung</label>
                        <select id="inp-wifi-type" class="input-field" onchange="updateQR()">
                            <option value="WPA">WPA/WPA2</option>
                            <option value="nopass">Offen</option>
                        </select>
                    </div>
                </div>

                <!-- WhatsApp -->
                <div id="form-whatsapp" class="form-section hidden space-y-3">
                    <div>
                        <label class="input-label">Nummer</label>
                        <div class="flex gap-2">
                            <select id="inp-wa-code" class="input-field w-24 shrink-0" onchange="updateQR()">
                                <option value="49">üá©üá™ +49</option>
                                <option value="43">üá¶üáπ +43</option>
                                <option value="41">üá®üá≠ +41</option>
                                <option value="1">üá∫üá∏ +1</option>
                            </select>
                            <input type="tel" id="inp-wa-phone" class="input-field" placeholder="170 1234567" oninput="validateField(this, 'phone'); updateQR()">
                        </div>
                        <p class="error-text">Bitte nur Ziffern eingeben.</p>
                        <p class="text-[10px] text-slate-500 mt-1">Nummer ohne f√ºhrende "0" eingeben.</p>
                    </div>
                    <div>
                        <label class="input-label">Nachricht</label>
                        <textarea id="inp-wa-text" rows="3" class="input-field" placeholder="Hallo, ich habe eine Frage..." oninput="updateQR()"></textarea>
                    </div>
                </div>

                <!-- Maps -->
                <div id="form-maps" class="form-section hidden space-y-3">
                    <div id="map-picker" class="border border-slate-300 dark:border-slate-700 shadow-inner"></div>
                    <div class="flex justify-between items-center">
                        <p class="text-[10px] text-slate-500">Klicke auf die Karte um Position zu setzen</p>
                        <button onclick="locateUser()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded flex items-center gap-1 shadow-md transition">
                            <i class="ph ph-crosshair"></i> Mein Standort
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="input-label">Breitengrad</label><input type="text" id="inp-geo-lat" class="input-field" placeholder="47.9511" oninput="updateQR()"></div>
                        <div><label class="input-label">L√§ngengrad</label><input type="text" id="inp-geo-long" class="input-field" placeholder="8.5024" oninput="updateQR()"></div>
                    </div>
                </div>

                <!-- SEPA -->
                <div id="form-sepa" class="form-section hidden space-y-3 bg-violet-50 dark:bg-violet-900/10 p-4 rounded-xl border border-violet-200 dark:border-violet-500/20">
                    <div><label class="input-label">Empf√§nger</label><input type="text" id="inp-sepa-name" class="input-field" placeholder="Max Mustermann" oninput="updateQR()"></div>
                    <div>
                        <label class="input-label">IBAN <i class="ph ph-info ml-1 cursor-help" title="International Bank Account Number"></i></label>
                        <input type="text" id="inp-sepa-iban" class="input-field uppercase" placeholder="DE00 0000 0000 0000 0000 00" oninput="validateField(this, 'iban'); updateQR()">
                        <p class="error-text">Bitte Format 'DE' gefolgt von Ziffern pr√ºfen.</p>
                        <p class="text-[10px] text-slate-500 mt-1">Format: DE‚Ä¶ ‚Äì bitte ohne Leerzeichen eingeben.</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="input-label">Betrag (‚Ç¨)</label><input type="number" step="0.01" id="inp-sepa-amount" class="input-field" placeholder="0.00" oninput="updateQR()"></div>
                        <div><label class="input-label">Zweck</label><input type="text" id="inp-sepa-ref" class="input-field" placeholder="Rechnungsnummer 123" oninput="updateQR()"></div>
                    </div>
                </div>

                <!-- vCard -->
                <div id="form-vcard" class="form-section hidden space-y-3">
                     <div class="grid grid-cols-2 gap-3">
                        <div><label class="input-label">Vorname</label><input type="text" id="inp-vc-first" class="input-field" placeholder="Max" oninput="updateQR()"></div>
                        <div><label class="input-label">Nachname</label><input type="text" id="inp-vc-last" class="input-field" placeholder="Mustermann" oninput="updateQR()"></div>
                    </div>
                    <div><label class="input-label">Firma</label><input type="text" id="inp-vc-org" class="input-field" placeholder="Musterfirma GmbH" oninput="updateQR()"></div>
                    <div><label class="input-label">Telefon</label><input type="tel" id="inp-vc-phone" class="input-field" placeholder="+49 170 1234567" oninput="updateQR()"></div>
                </div>

                <!-- PayPal -->
                <div id="form-paypal" class="form-section hidden space-y-3 bg-blue-50 dark:bg-blue-900/10 p-4 rounded-xl border border-blue-200 dark:border-blue-500/20">
                    <div class="text-blue-600 dark:text-blue-300 text-xs mb-2 flex items-center gap-2">
                        <i class="ph ph-paypal-logo"></i> Generiert einen PayPal.Me Link.
                    </div>
                    <div>
                        <label class="input-label">PayPal Nutzername</label>
                        <input type="text" id="inp-pp-user" class="input-field" placeholder="DeinNutzername" oninput="updateQR()">
                    </div>
                    <div>
                        <label class="input-label">Betrag (Optional)</label>
                        <input type="number" step="0.50" id="inp-pp-amount" class="input-field" placeholder="25.00" oninput="updateQR()">
                    </div>
                    <div>
                        <label class="input-label">W√§hrung</label>
                        <select id="inp-pp-curr" class="input-field" onchange="updateQR()">
                            <option value="EUR">EUR (‚Ç¨)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>

                <!-- Review -->
                <div id="form-review" class="form-section hidden space-y-3 bg-yellow-50 dark:bg-yellow-900/10 p-4 rounded-xl border border-yellow-200 dark:border-yellow-500/20">
                    <div class="text-yellow-600 dark:text-yellow-300 text-xs mb-2 flex items-center gap-2">
                        <i class="ph ph-star-half"></i> Leitet direkt zur Bewertung.
                    </div>
                    <div>
                        <label class="input-label">Google Maps Link</label>
                        <input type="url" id="inp-rev-url" class="input-field" placeholder="https://g.page/r/..." oninput="validateField(this, 'url'); updateQR()">
                        <p class="error-text">Bitte vollst√§ndige URL mit http(s) eingeben.</p>
                        <p class="text-[10px] text-slate-500 mt-1">Nutze hier den direkten Bewertungs-Link deiner Google-Firmenseite.</p>
                    </div>
                </div>

                <!-- Phone -->
                <div id="form-phone" class="form-section hidden space-y-3">
                    <div>
                        <label class="input-label">Telefonnummer</label>
                        <input type="tel" id="inp-ph-num" class="input-field" placeholder="+49 123 4567890" oninput="validateField(this, 'phone'); updateQR()">
                        <p class="error-text">Bitte Format pr√ºfen.</p>
                        <p class="text-[10px] text-slate-500 mt-1">Mit L√§ndervorwahl, ohne f√ºhrende 0 nach der Vorwahl.</p>
                    </div>
                    <div>
                        <label class="input-label">Aktion beim Scannen</label>
                        <select id="inp-ph-action" class="input-field" onchange="updateQR()">
                            <option value="tel">Anrufen (Dialer √∂ffnen)</option>
                            <option value="sms">SMS schreiben</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>

        <!-- Middle Column: Design -->
        <div class="w-full lg:w-1/3 p-4 lg:p-6 border-b lg:border-b-0 lg:border-r border-slate-200 dark:border-slate-800 overflow-y-auto bg-slate-50 dark:bg-slate-800/50 transition-colors">
            <h2 class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase mb-4 flex items-center gap-2">
                <i class="ph ph-paint-brush-broad"></i> 2. Design Studio
            </h2>

            <!-- Design Mode Toggle -->
            <div class="flex p-1 bg-slate-200 dark:bg-slate-700 rounded-lg mb-6">
                <button onclick="setDesignMode('simple')" id="btn-design-simple" class="flex-1 text-xs font-medium py-1.5 rounded-md transition bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white">Einfach</button>
                <button onclick="setDesignMode('advanced')" id="btn-design-advanced" class="flex-1 text-xs font-medium py-1.5 rounded-md transition text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200">Erweitert</button>
            </div>

            <div class="space-y-6">
                <!-- Simple Mode Controls (Always Visible) -->
                <div class="space-y-3">
                    <label class="input-label">Farbe & Form</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase block mb-1">Code Farbe</label>
                            <input type="color" id="col-fg" value="#000000" class="h-8 w-full bg-slate-200 dark:bg-slate-700 rounded cursor-pointer border-0 p-0 shadow-sm" oninput="updateQR()">
                        </div>
                        <div>
                             <label class="text-[10px] text-slate-500 uppercase block mb-1">Form</label>
                             <select id="style-dots" class="input-field text-xs h-8 py-1" onchange="updateQR()">
                                 <option value="square">Eckig</option>
                                 <option value="dots">Punkte</option>
                                 <option value="rounded">Rund</option>
                                 <option value="extra-rounded">Soft</option>
                                 <option value="classy">Edel</option>
                             </select>
                        </div>
                    </div>
                </div>

                <!-- Advanced Mode Controls (Conditional) -->
                <div id="advanced-controls" class="hidden space-y-6 border-t border-slate-200 dark:border-slate-700 pt-6">
                    
                     <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="use-gradient" onchange="toggleGradient()" class="rounded bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-500 text-violet-600">
                            <label for="use-gradient" class="input-label mb-0 cursor-pointer">Verlauf <i class="ph ph-info ml-1 text-slate-400 cursor-help" title="Zu wenig Kontrast kann Scannen erschweren"></i></label>
                        </div>
                        <div id="gradient-ui" class="hidden mt-2">
                             <input type="color" id="col-fg2" value="#8b5cf6" class="h-8 w-full bg-slate-200 dark:bg-slate-700 rounded cursor-pointer border-0 p-0 shadow-sm" oninput="updateQR()">
                        </div>
                    </div>

                    <!-- Logo -->
                    <div class="space-y-3">
                        <label class="input-label">Logo</label>
                        <div class="flex gap-2 mb-2">
                            <label class="flex-1 cursor-pointer bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-white py-2 rounded text-xs text-center border border-slate-300 dark:border-slate-600 transition flex items-center justify-center gap-2 shadow-sm">
                                <i class="ph ph-upload-simple"></i> Upload
                                <input type="file" id="logo-upload" class="hidden" accept="image/*" onchange="handleLogoUpload(this)">
                            </label>
                            <button onclick="clearLogo()" class="px-3 bg-slate-200 dark:bg-slate-700 hover:bg-red-100 dark:hover:bg-slate-600 text-red-500 dark:text-red-400 rounded border border-slate-300 dark:border-slate-600 shadow-sm"><i class="ph ph-trash"></i></button>
                        </div>
                        <p class="text-[10px] text-slate-500 mb-2">Nutze am besten ein einfaches, kontrastreiches Logo ‚Äì zu viel Detail kann das Scannen erschweren.</p>
                        
                        <label class="text-[10px] text-slate-500 uppercase block mb-1">Presets</label>
                        <div class="grid grid-cols-4 gap-2">
                             <!-- Row 1 -->
                             <button onclick="setPresetLogo('whatsapp')" title="WhatsApp" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-green-500 transition"><i class="ph ph-whatsapp-logo text-xl"></i></button>
                             <button onclick="setPresetLogo('wifi')" title="WiFi" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-blue-500 transition"><i class="ph ph-wifi-high text-xl"></i></button>
                             <button onclick="setPresetLogo('maps')" title="Maps" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-red-500 transition"><i class="ph ph-map-pin text-xl"></i></button>
                             <button onclick="setPresetLogo('printer')" title="3D Druck" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-violet-500 transition"><i class="ph ph-cube text-xl"></i></button>
                             
                             <!-- Row 2 -->
                             <button onclick="setPresetLogo('paypal')" title="PayPal" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-blue-400 transition"><i class="ph ph-paypal-logo text-xl"></i></button>
                             <button onclick="setPresetLogo('google')" title="Google" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-white transition"><i class="ph ph-google-logo text-xl"></i></button>
                             <button onclick="setPresetLogo('youtube')" title="YouTube" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-red-600 transition"><i class="ph ph-youtube-logo text-xl"></i></button>
                             <button onclick="setPresetLogo('facebook')" title="Facebook" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-blue-600 transition"><i class="ph ph-facebook-logo text-xl"></i></button>
                             
                             <!-- Row 3 -->
                             <button onclick="setPresetLogo('instagram')" title="Instagram" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-pink-500 transition"><i class="ph ph-instagram-logo text-xl"></i></button>
                             <button onclick="setPresetLogo('phone')" title="Telefon" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-green-400 transition"><i class="ph ph-phone text-xl"></i></button>
                             <button onclick="setPresetLogo('email')" title="E-Mail" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-yellow-400 transition"><i class="ph ph-envelope text-xl"></i></button>
                             <button onclick="setPresetLogo('euro')" title="Euro / Bank" class="bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 p-2 rounded flex items-center justify-center text-slate-400 hover:text-emerald-400 transition"><i class="ph ph-currency-eur text-xl"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Preview & Footer -->
        <div class="w-full lg:w-1/3 p-6 bg-slate-100 dark:bg-slate-950 flex flex-col relative transition-colors overflow-y-auto">
            
            <div id="main-preview-area" class="flex flex-col items-center w-full mt-4">
                <div class="text-center mb-6">
                     <h3 class="text-emerald-500 dark:text-emerald-400 font-bold uppercase tracking-widest text-xs mb-1">Live Vorschau</h3>
                </div>

                <div id="qr-wrapper" class="bg-white dark:bg-white/5 p-6 rounded-3xl shadow-2xl border border-slate-200 dark:border-white/10 mb-4 transition-transform hover:scale-[1.02] backdrop-blur-sm">
                    <div id="canvas-container"></div>
                </div>
                
                <div class="text-center mb-6">
                    <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">Tipp: Mit der Handy-Kamera testen, bevor du druckst.</p>
                    <p class="text-[10px] text-slate-500 mt-1">Achte auf guten Kontrast (dunkler Code auf hellem Hintergrund).</p>
                </div>

                <div class="w-full max-w-xs space-y-3 mb-8">
                    <button onclick="downloadQR('png')" class="w-full bg-violet-600 hover:bg-violet-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-violet-500/20 transition-all flex justify-center items-center gap-2 hover:-translate-y-1">
                        <i class="ph ph-download-simple text-xl"></i> Download PNG
                    </button>
                    <button onclick="downloadQR('svg')" class="w-full bg-slate-200 dark:bg-slate-900 hover:bg-slate-300 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 py-2 rounded-lg border border-slate-300 dark:border-slate-800 transition text-sm flex justify-center items-center gap-2">
                        <i class="ph ph-bezier-curve"></i> Download SVG (Vektor)
                    </button>
                </div>

                <!-- Recommend Box -->
                <div class="mb-8 p-4 rounded-xl bg-gradient-to-br from-emerald-500 to-green-600 text-white shadow-lg relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 bg-white/10 w-24 h-24 rounded-full blur-2xl group-hover:bg-white/20 transition"></div>
                    
                    <h4 class="font-bold text-lg mb-1 flex items-center gap-2">
                        <i class="ph ph-thumbs-up"></i> Gef√§llt dir das Tool?
                    </h4>
                    <p class="text-xs text-emerald-50 mb-4 opacity-90">Unterst√ºtze die Warenschmiede und teile es mit Freunden.</p>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <a href="https://wa.me/?text=Hey%2C%20check%20mal%20diesen%20kostenlosen%20QR-Generator%20der%20Warenschmiede%20aus%3A%20https%3A%2F%2Fwww.warenschmiede.com%2F%20-%20Komplett%20offline%20und%20sicher!" 
                           target="_blank"
                           class="flex items-center justify-center gap-2 bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition backdrop-blur-sm border border-white/10">
                            <i class="ph ph-whatsapp-logo text-lg"></i> WhatsApp
                        </a>
                        <button onclick="copyShareLink()" 
                                class="flex items-center justify-center gap-2 bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition backdrop-blur-sm border border-white/10">
                            <i class="ph ph-copy text-lg"></i> Link kopieren
                        </button>
                    </div>
                </div>
            </div>

            <!-- Security Box -->
            <div class="mt-auto bg-slate-200 dark:bg-slate-900 p-4 rounded-xl border border-slate-300 dark:border-slate-800">
                <h4 class="font-bold text-sm text-slate-800 dark:text-white flex items-center gap-2 mb-2">
                    <i class="ph ph-shield-check text-green-500"></i> Warum dieses Tool sicher ist
                </h4>
                <ul class="text-[11px] text-slate-600 dark:text-slate-400 space-y-1 list-disc ml-4">
                    <li>L√§uft komplett im Browser ‚Äì deine Daten werden niemals an einen Server gesendet.</li>
                    <li>Keine Werbung, keine Abos, keine versteckten Kosten.</li>
                    <li>Dieses Tool ist und bleibt kostenlos.</li>
                </ul>
            </div>

            <!-- FAQ Accordion -->
            <div class="mt-6 border-t border-slate-300 dark:border-slate-800 pt-6">
                <h4 class="text-xs font-bold uppercase text-slate-500 mb-3">H√§ufige Fragen</h4>
                <div class="space-y-2">
                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer list-none text-xs text-slate-700 dark:text-slate-300">
                            <span>Wie teste ich meinen QR-Code?</span>
                            <span class="transition group-open:rotate-180"><i class="ph ph-caret-down"></i></span>
                        </summary>
                        <p class="text-[11px] text-slate-500 mt-2 leading-relaxed">
                            Speichere den Code, zeige ihn am Bildschirm und scanne ihn mit der Kamera-App deines Smartphones. Wenn der richtige Inhalt ge√∂ffnet wird, passt alles.
                        </p>
                    </details>
                    <div class="h-px bg-slate-200 dark:bg-slate-800"></div>
                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer list-none text-xs text-slate-700 dark:text-slate-300">
                            <span>Wie gro√ü muss der Code gedruckt werden?</span>
                            <span class="transition group-open:rotate-180"><i class="ph ph-caret-down"></i></span>
                        </summary>
                        <p class="text-[11px] text-slate-500 mt-2 leading-relaxed">
                            F√ºr Flyer und Visitenkarten mindestens etwa 2 x 2 cm, f√ºr Plakate deutlich gr√∂√üer. Wichtig ist immer hoher Kontrast und gen√ºgend Abstand zum Rand.
                        </p>
                    </details>
                    <div class="h-px bg-slate-200 dark:bg-slate-800"></div>
                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer list-none text-xs text-slate-700 dark:text-slate-300">
                            <span>Darf ich die Codes kommerziell nutzen?</span>
                            <span class="transition group-open:rotate-180"><i class="ph ph-caret-down"></i></span>
                        </summary>
                        <p class="text-[11px] text-slate-500 mt-2 leading-relaxed">
                            Ja. Du darfst die mit diesem Tool erzeugten QR-Codes privat und gesch√§ftlich verwenden.
                        </p>
                    </details>
                    <div class="h-px bg-slate-200 dark:bg-slate-800"></div>
                     <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer list-none text-xs text-slate-700 dark:text-slate-300">
                            <span>Speichert ihr meine Daten?</span>
                            <span class="transition group-open:rotate-180"><i class="ph ph-caret-down"></i></span>
                        </summary>
                        <p class="text-[11px] text-slate-500 mt-2 leading-relaxed">
                            Nein. Alles l√§uft lokal in deinem Browser. Deine Daten (WLAN-Passw√∂rter, IBANs usw.) werden nicht an einen Server gesendet.
                        </p>
                    </details>
                </div>
            </div>

        </div>

    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0 p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl p-8 shadow-2xl transform transition-transform scale-95 border border-slate-200 dark:border-slate-700 relative">
            <button onclick="toggleInfoModal()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition"><i class="ph ph-x text-xl"></i></button>
            
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-violet-100 dark:bg-violet-900/30 text-violet-600 dark:text-violet-400 mb-4">
                    <i class="ph ph-shield-check text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold dark:text-white">100% Sicher & Kostenlos</h2>
            </div>
            
            <div class="space-y-4 text-sm text-slate-600 dark:text-slate-300">
                <div class="flex gap-3">
                    <i class="ph ph-lock-key text-lg text-emerald-500 mt-1"></i>
                    <div>
                        <h4 class="font-bold text-slate-900 dark:text-white">Datenschutz Priorit√§t</h4>
                        <p>Dieser Generator l√§uft komplett in deinem Browser. Deine Daten (WLAN-Passw√∂rter, IBANs, etc.) werden <strong>niemals</strong> an einen Server gesendet.</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <i class="ph ph-prohibit text-lg text-red-500 mt-1"></i>
                    <div>
                        <h4 class="font-bold text-slate-900 dark:text-white">Keine Werbung, Keine Abos</h4>
                        <p>Dieses Tool ist und bleibt kostenlos. Es gibt keine versteckten Kosten, keine "Pro"-Versionen und keine nervigen Popups.</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <i class="ph ph-printer text-lg text-blue-500 mt-1"></i>
                    <div>
                        <h4 class="font-bold text-slate-900 dark:text-white">Druck-Tipp</h4>
                        <p>Verwende f√ºr gro√üe Drucke (Plakate, Autos, Schilder) immer SVG verwenden und mindestens 3‚Äì4 cm Kantenl√§nge einplanen.</p>
                    </div>
                </div>
                <div class="flex gap-3 mt-6 pt-4 border-t border-slate-200 dark:border-slate-700 justify-center">
                     <p class="text-xs text-slate-400">by Warenschmiede Tools</p>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="toggleInfoModal()" class="bg-slate-900 dark:bg-slate-700 text-white px-6 py-2 rounded-lg font-medium hover:bg-slate-800 dark:hover:bg-slate-600 transition">Verstanden</button>
            </div>
        </div>
    </div>

    <!-- Legal Modal (New) -->
    <div id="legal-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0 p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl p-6 shadow-2xl transform transition-transform scale-95 border border-slate-200 dark:border-slate-700 relative">
            <button onclick="toggleLegalModal()" class="absolute top-4 right-4 text-slate-400 hover:text-red-500 transition"><i class="ph ph-x text-xl"></i></button>
            
            <div class="mb-6">
                <h2 class="text-xl font-bold dark:text-white flex items-center gap-2">
                    <i class="ph ph-gavel text-violet-500"></i> Rechtliches
                </h2>
                <p class="text-xs text-slate-500 mt-1">Links zu Warenschmiede.com</p>
            </div>
            
            <div class="space-y-2">
                <a href="https://www.warenschmiede.com/impressum.html" target="_blank" class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-500 group-hover:text-violet-500 transition">
                            <i class="ph ph-identification-card text-lg"></i>
                        </div>
                        <span class="font-medium text-sm text-slate-700 dark:text-slate-200">Impressum</span>
                    </div>
                    <i class="ph ph-arrow-square-out text-slate-400"></i>
                </a>

                <a href="https://www.warenschmiede.com/datenschutz.html" target="_blank" class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-500 group-hover:text-emerald-500 transition">
                            <i class="ph ph-shield text-lg"></i>
                        </div>
                        <span class="font-medium text-sm text-slate-700 dark:text-slate-200">Datenschutz</span>
                    </div>
                    <i class="ph ph-arrow-square-out text-slate-400"></i>
                </a>

                <a href="https://www.warenschmiede.com/kontakt.html" target="_blank" class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-500 group-hover:text-blue-500 transition">
                            <i class="ph ph-envelope-simple text-lg"></i>
                        </div>
                        <span class="font-medium text-sm text-slate-700 dark:text-slate-200">Kontakt</span>
                    </div>
                    <i class="ph ph-arrow-square-out text-slate-400"></i>
                </a>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="toggleLegalModal()" class="text-xs text-slate-500 hover:text-slate-800 dark:hover:text-slate-300 underline">Schlie√üen</button>
            </div>
        </div>
    </div>

    <script>
        // --- Init Code ---
        let qrCode = new QRCodeStyling({
            width: 300, height: 300, type: "svg", data: "https://deine-website.de",
            dotsOptions: { color: "#000000", type: "rounded" },
            backgroundOptions: { color: "#ffffff" },
            imageOptions: { crossOrigin: "anonymous", margin: 8 }
        });

        let currentMode = 'url';
        let logoUrl = "";
        let map = null;
        let marker = null;
        
        // Kinderleichte Erkl√§rungen
        const infoTexts = {
            url: "Scan √∂ffnet sofort deine Website oder jeden beliebigen Link im Browser.",
            wifi: "Scan verbindet das Smartphone direkt mit deinem WLAN ‚Äì ohne Passwort tippen.",
            whatsapp: "Scan √∂ffnet einen WhatsApp-Chat zu dir mit vorbereiteter Nachricht.",
            maps: "Scan √∂ffnet direkt die Navigation zu diesem Standort in Google Maps.",
            sepa: "Scan erstellt eine fertige SEPA-√úberweisung (Empf√§nger, IBAN, Betrag, Verwendungszweck).",
            vcard: "Scan speichert deinen Kontakt (Name, Nummer, E-Mail) direkt im Handy des anderen.",
            paypal: "Scan startet eine PayPal.Me-Zahlung an dich, Betrag optional voreingestellt.",
            review: "Scan f√ºhrt direkt zu deiner Google-Bewertungsseite.",
            phone: "Scan ruft deine Nummer an oder √∂ffnet eine SMS ‚Äì je nach Einstellung."
        };

        document.getElementById('canvas-container').innerHTML = "";
        qrCode.append(document.getElementById('canvas-container'));

        // Init Text
        document.getElementById('desc-text').innerText = infoTexts['url'];

        // --- Validation Logic ---
        function validateField(input, type) {
            const val = input.value;
            let isValid = true;

            // Remove previous error state
            input.classList.remove('input-error');

            if (type === 'url' && val.length > 0) {
                if (!/^https?:\/\//i.test(val)) isValid = false;
            }
            if (type === 'iban' && val.length > 0) {
                // Simple pattern check for DE IBANs or generic length
                if (!/^DE\d{20}$/i.test(val.replace(/\s/g, '')) && !/^[A-Z]{2}\d+$/.test(val.replace(/\s/g, ''))) isValid = false;
            }
            if (type === 'phone' && val.length > 0) {
                if (!/^[+]?[0-9\s]+$/.test(val)) isValid = false;
            }

            if (!isValid) {
                input.classList.add('input-error');
            }
        }

        // --- Design Mode Logic ---
        function setDesignMode(mode) {
            const advControls = document.getElementById('advanced-controls');
            const btnSimple = document.getElementById('btn-design-simple');
            const btnAdv = document.getElementById('btn-design-advanced');

            if (mode === 'simple') {
                advControls.classList.add('hidden');
                btnSimple.classList.remove('text-slate-500', 'dark:text-slate-400', 'hover:text-slate-800');
                btnSimple.classList.add('bg-white', 'dark:bg-slate-600', 'shadow', 'text-slate-800', 'dark:text-white');
                
                btnAdv.classList.add('text-slate-500', 'dark:text-slate-400', 'hover:text-slate-800');
                btnAdv.classList.remove('bg-white', 'dark:bg-slate-600', 'shadow', 'text-slate-800', 'dark:text-white');
            } else {
                advControls.classList.remove('hidden');
                btnAdv.classList.remove('text-slate-500', 'dark:text-slate-400', 'hover:text-slate-800');
                btnAdv.classList.add('bg-white', 'dark:bg-slate-600', 'shadow', 'text-slate-800', 'dark:text-white');

                btnSimple.classList.add('text-slate-500', 'dark:text-slate-400', 'hover:text-slate-800');
                btnSimple.classList.remove('bg-white', 'dark:bg-slate-600', 'shadow', 'text-slate-800', 'dark:text-white');
            }
        }

        // --- Toggle Modals ---
        function toggleInfoModal() {
            toggleModal('info-modal');
        }

        function toggleLegalModal() {
            toggleModal('legal-modal');
        }

        function toggleModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('div');
            
            if(modal.classList.contains('hidden')) {
                // Open
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }, 10);
            } else {
                // Close
                modal.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }
        }

        // --- Theme Toggle ---
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if(html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.classList.remove('ph-sun');
                icon.classList.add('ph-moon');
            } else {
                html.classList.add('dark');
                icon.classList.remove('ph-moon');
                icon.classList.add('ph-sun');
            }
        }

        // --- Share Function ---
        function copyShareLink() {
            const text = "https://www.warenschmiede.com/";
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert("Link kopiert!");
            } catch (err) {
                prompt("Link kopieren:", text);
            }
            document.body.removeChild(textArea);
        }

        // --- Map Logic ---
        function initMap() {
            if(map) return; 
            map = L.map('map-picker').setView([47.95, 8.50], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                if(marker) map.removeLayer(marker);
                marker = L.marker([lat, lng]).addTo(map);
                
                document.getElementById('inp-geo-lat').value = lat;
                document.getElementById('inp-geo-long').value = lng;
                updateQR();
            });
        }

        function locateUser() {
            if (!navigator.geolocation) {
                alert("Browser unterst√ºtzt keine Ortung.");
                return;
            }
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                document.getElementById('inp-geo-lat').value = lat.toFixed(6);
                document.getElementById('inp-geo-long').value = lng.toFixed(6);
                
                if(map) {
                    map.setView([lat, lng], 16);
                    if(marker) map.removeLayer(marker);
                    marker = L.marker([lat, lng]).addTo(map);
                }
                updateQR();
            }, () => alert("Standort konnte nicht abgerufen werden."));
        }

        // --- Mode Switching ---
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.form-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`form-${mode}`).classList.remove('hidden');

            // Update Help Text
            document.getElementById('desc-text').innerText = infoTexts[mode] || "W√§hle eine Funktion.";

            if(mode === 'maps') {
                setTimeout(initMap, 100);
                setTimeout(() => { if(map) map.invalidateSize(); }, 200); 
            }

            updateQR();
        }

        // --- Update Logic ---
        function updateQR() {
            const data = generateDataString();
            const fg = document.getElementById('col-fg').value;
            const useGrad = document.getElementById('use-gradient').checked;
            const fg2 = document.getElementById('col-fg2').value;
            const style = document.getElementById('style-dots').value;

            let dots = { color: fg, type: style };
            if (useGrad) dots.gradient = { type: "linear", rotation: 45, colorStops: [{ offset: 0, color: fg }, { offset: 1, color: fg2 }] };

            qrCode.update({
                data: data,
                dotsOptions: dots,
                cornersSquareOptions: { type: style === 'dots' ? 'dot' : 'square', color: fg },
                cornersDotOptions: { type: style === 'dots' ? 'dot' : 'square', color: fg },
                image: logoUrl
            });
        }

        function generateDataString() {
            switch(currentMode) {
                case 'url': return document.getElementById('inp-url').value;
                case 'wifi':
                    return `WIFI:T:${document.getElementById('inp-wifi-type').value};S:${document.getElementById('inp-wifi-ssid').value};P:${document.getElementById('inp-wifi-pass').value};;`;
                case 'whatsapp':
                    const code = document.getElementById('inp-wa-code').value;
                    let num = document.getElementById('inp-wa-phone').value.replace(/\s/g, '').replace(/^0/, ''); 
                    const text = encodeURIComponent(document.getElementById('inp-wa-text').value);
                    return `https://wa.me/${code}${num}?text=${text}`;
                case 'maps':
                    const lat = document.getElementById('inp-geo-lat').value;
                    const long = document.getElementById('inp-geo-long').value;
                    return `http://maps.google.com/maps?q=${lat},${long}`;
                case 'sepa':
                    const name = document.getElementById('inp-sepa-name').value;
                    const iban = document.getElementById('inp-sepa-iban').value.replace(/\s/g, '');
                    const amount = document.getElementById('inp-sepa-amount').value;
                    const ref = document.getElementById('inp-sepa-ref').value;
                    let str = "BCD\n002\n1\nSCT\n\n" + name + "\n" + iban + "\n" + (amount ? `EUR${amount}` : "") + "\n\n\n" + ref + "\n";
                    return str;
                case 'vcard':
                    return `BEGIN:VCARD\nVERSION:3.0\nFN:${document.getElementById('inp-vc-first').value} ${document.getElementById('inp-vc-last').value}\nORG:${document.getElementById('inp-vc-org').value}\nTEL:${document.getElementById('inp-vc-phone').value}\nEND:VCARD`;
                case 'paypal':
                    const ppUser = document.getElementById('inp-pp-user').value;
                    const ppAmt = document.getElementById('inp-pp-amount').value;
                    const ppCurr = document.getElementById('inp-pp-curr').value;
                    let ppUrl = `https://www.paypal.com/paypalme/${ppUser}`;
                    if(ppAmt) ppUrl += `/${ppAmt}${ppCurr}`;
                    return ppUrl;
                case 'review':
                    return document.getElementById('inp-rev-url').value || "https://google.com";
                case 'phone':
                    const phNum = document.getElementById('inp-ph-num').value;
                    const phAct = document.getElementById('inp-ph-action').value;
                    if(phAct === 'sms') return `smsto:${phNum}`;
                    return `tel:${phNum}`;
                default: return "Error";
            }
        }

        // --- Helpers ---
        function toggleGradient() {
            const use = document.getElementById('use-gradient').checked;
            document.getElementById('gradient-ui').classList.toggle('hidden', !use);
            updateQR();
        }
        function handleLogoUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { logoUrl = e.target.result; updateQR(); };
            reader.readAsDataURL(file);
        }
        function clearLogo() { logoUrl = ""; updateQR(); }
        
        function setPresetLogo(type) {
             const icons = {
                whatsapp: "https://cdn-icons-png.flaticon.com/512/3670/3670051.png",
                wifi: "https://cdn-icons-png.flaticon.com/512/93/93158.png",
                maps: "https://cdn-icons-png.flaticon.com/512/854/854878.png",
                printer: "https://cdn-icons-png.flaticon.com/512/2822/2822668.png",
                paypal: "https://cdn-icons-png.flaticon.com/512/174/174861.png",
                google: "https://cdn-icons-png.flaticon.com/512/300/300221.png",
                youtube: "https://cdn-icons-png.flaticon.com/512/1384/1384060.png",
                facebook: "https://cdn-icons-png.flaticon.com/512/5968/5968764.png",
                instagram: "https://cdn-icons-png.flaticon.com/512/3955/3955024.png",
                phone: "https://cdn-icons-png.flaticon.com/512/724/724664.png",
                email: "https://cdn-icons-png.flaticon.com/512/542/542638.png",
                euro: "https://cdn-icons-png.flaticon.com/512/2535/2535074.png"
            };
            logoUrl = icons[type];
            updateQR();
        }
        
        // --- Storage ---
        function saveDesignPreset() {
             const config = {
                fg: document.getElementById('col-fg').value,
                dotStyle: document.getElementById('style-dots').value
            };
            localStorage.setItem('qr_design_ultra', JSON.stringify(config));
            alert("Design gespeichert!");
        }
        function resetDesign() { localStorage.removeItem('qr_design_ultra'); location.reload(); }

        function downloadQR(ext) { qrCode.download({ name: `QR_Master_${currentMode}`, extension: ext }); }
    </script>
</body>
</html>